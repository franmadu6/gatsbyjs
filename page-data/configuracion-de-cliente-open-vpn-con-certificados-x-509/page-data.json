{"componentChunkName":"component---src-templates-post-js","path":"/configuracion-de-cliente-open-vpn-con-certificados-x-509","result":{"data":{"markdownRemark":{"html":"<h2 id=\"configuración-de-cliente-openvpn-con-certificados-x509\"><a href=\"#configuraci%C3%B3n-de-cliente-openvpn-con-certificados-x509\" aria-label=\"configuración de cliente openvpn con certificados x509 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configuración de cliente OpenVPN con certificados X.509</h2>\n<h3 id=\"para-poder-acceder-a-la-red-local-desde-el-exterior-existe-una-red-privada-configurada-con-openvpn-que-utiliza-certificados-x509-para-autenticar-los-usuarios-y-el-servidor\"><a href=\"#para-poder-acceder-a-la-red-local-desde-el-exterior-existe-una-red-privada-configurada-con-openvpn-que-utiliza-certificados-x509-para-autenticar-los-usuarios-y-el-servidor\" aria-label=\"para poder acceder a la red local desde el exterior existe una red privada configurada con openvpn que utiliza certificados x509 para autenticar los usuarios y el servidor permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Para poder acceder a la red local desde el exterior, existe una red privada configurada con OpenVPN que utiliza certificados x509 para autenticar los usuarios y el servidor.</h3>\n<ul>\n<li>\n<p>Genera una clave privada RSA 4096</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@debian:/home/fran/Documentos<span class=\"token comment\"># openssl genrsa 4096 > /etc/ssl/private/maduvpn.key</span>\nGenerating RSA private key, <span class=\"token number\">4096</span> bit long modulus <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> primes<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.++++\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.++++\ne is <span class=\"token number\">65537</span> <span class=\"token punctuation\">(</span>0x010001<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>Genera una solicitud de firma de certificado (fichero CSR) y súbelo a gestiona</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@debian:~<span class=\"token comment\"># openssl req -new -key /etc/ssl/private/maduvpn.key -out /root/maduvpn.csr</span>\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter <span class=\"token string\">'.'</span>, the field will be left blank.\n-----\nCountry Name <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> letter code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>AU<span class=\"token punctuation\">]</span>:ES\nState or Province Name <span class=\"token punctuation\">(</span>full name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Some-State<span class=\"token punctuation\">]</span>:Sevilla\nLocality Name <span class=\"token punctuation\">(</span>eg, city<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:Dos Hermanas\nOrganization Name <span class=\"token punctuation\">(</span>eg, company<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Internet Widgits Pty Ltd<span class=\"token punctuation\">]</span>:IES Gonzalo Nazareno\nOrganizational Unit Name <span class=\"token punctuation\">(</span>eg, section<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:Asir\nCommon Name <span class=\"token punctuation\">(</span>e.g. server FQDN or YOUR name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:maduvpn  \nEmail Address <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:frandh1997@gmail.com\nPlease enter the following <span class=\"token string\">'extra'</span> attributes\nto be sent with your certificate request\nA challenge password <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:\nAn optional company name <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:</code></pre></div>\n</li>\n</ul>\n<p>Una vez generado el certificado deberemos ir a gestiona \"<a href=\"https://dit.gonzalonazareno.org/gestiona/cert/\">https://dit.gonzalonazareno.org/gestiona/cert/</a>\" subirlo y esperar su regreso.\nNos llegará nuestro archivo .crt y estara certificado por el cetro.</p>\n<ul>\n<li>Instala y configura apropiadamente el cliente openvpn y muestra los registros (logs) del sistema que demuestren que se ha establecido una conexión.</li>\n</ul>\n<p>Instalaremos nuestro cliente openvpn</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">fran@debian:~$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> openvpn</code></pre></div>\n<p>Ahora con paquete instalado moveremos el certificado a /etc/openvpn</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@debian:/etc/openvpn<span class=\"token comment\"># ls</span>\nclient\tmaduvpn.crt  server  update-resolv-conf</code></pre></div>\n<p>Crearemos un fichero de configuración nuevo y le añadiremos las siguientes lineas</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\">#sputnik.conf</span>\ndev tun\nremote sputnik.gonzalonazareno.org\n<span class=\"token function\">ifconfig</span> <span class=\"token number\">172.23</span>.0.0 <span class=\"token number\">255.255</span>.255.0\npull\nproto tcp-client\ntls-client\nremote-cert-tls server\nca /etc/ssl/certs/gonzalonazareno.crt            \ncert /etc/openvpn/maduvpn.crt\nkey /etc/ssl/private/maduvpn.key\ncomp-lzo\nkeepalive <span class=\"token number\">10</span> <span class=\"token number\">60</span>\nlog /var/log/openvpn-sputnik.log\nverb <span class=\"token number\">1</span></code></pre></div>\n<p>Reiniciamos el servicio de openvpn</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@debian:/etc/openvpn<span class=\"token comment\"># /etc/init.d/openvpn restart</span>\n<span class=\"token punctuation\">[</span> ok <span class=\"token punctuation\">]</span> Restarting openvpn <span class=\"token punctuation\">(</span>via systemctl<span class=\"token punctuation\">)</span>: openvpn.service.</code></pre></div>\n<p>Commprobamos que se ha creado la regla de encaminamiento para acceder a los equipos de la 172.22.0.0/16.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">fran@debian:~$ <span class=\"token function\">ip</span> r\ndefault via <span class=\"token number\">192.168</span>.1.1 dev wlo1 proto dhcp metric <span class=\"token number\">600</span> \n<span class=\"token number\">169.254</span>.0.0/16 dev wlo1 scope <span class=\"token function\">link</span> metric <span class=\"token number\">1000</span> \n<span class=\"token number\">172.22</span>.0.0/16 via <span class=\"token number\">172.23</span>.0.93 dev tun0 \n<span class=\"token number\">172.23</span>.0.1 via <span class=\"token number\">172.23</span>.0.93 dev tun0 \n<span class=\"token number\">172.23</span>.0.93 dev tun0 proto kernel scope <span class=\"token function\">link</span> src <span class=\"token number\">172.23</span>.0.94 \n<span class=\"token number\">192.168</span>.1.0/24 dev wlo1 proto kernel scope <span class=\"token function\">link</span> src <span class=\"token number\">192.168</span>.1.139 metric <span class=\"token number\">600</span> </code></pre></div>\n<p>Comprobamos los mensajes de log</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@debian:/home/fran<span class=\"token comment\"># cat /var/log/openvpn-sputnik.log</span>\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:38 <span class=\"token number\">2020</span> WARNING: <span class=\"token function\">file</span> <span class=\"token string\">'/etc/ssl/private/maduvpn.key'</span> is group or others accessible\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:38 <span class=\"token number\">2020</span> OpenVPN <span class=\"token number\">2.4</span>.7 x86_64-pc-linux-gnu <span class=\"token punctuation\">[</span>SSL <span class=\"token punctuation\">(</span>OpenSSL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>LZO<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>LZ4<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>EPOLL<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>PKCS11<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>MH/PKTINFO<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>AEAD<span class=\"token punctuation\">]</span> built on Feb <span class=\"token number\">20</span> <span class=\"token number\">2019</span>\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:38 <span class=\"token number\">2020</span> library versions: OpenSSL <span class=\"token number\">1.1</span>.1d  <span class=\"token number\">10</span> Sep <span class=\"token number\">2019</span>, LZO <span class=\"token number\">2.10</span>\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:38 <span class=\"token number\">2020</span> WARNING: using --pull/--client and --ifconfig together is probably not what you want\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:38 <span class=\"token number\">2020</span> TCP/UDP: Preserving recently used remote address: <span class=\"token punctuation\">[</span>AF_INET<span class=\"token punctuation\">]</span><span class=\"token number\">92.222</span>.86.77:1194\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:38 <span class=\"token number\">2020</span> Attempting to establish TCP connection with <span class=\"token punctuation\">[</span>AF_INET<span class=\"token punctuation\">]</span><span class=\"token number\">92.222</span>.86.77:1194 <span class=\"token punctuation\">[</span>nonblock<span class=\"token punctuation\">]</span>\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:39 <span class=\"token number\">2020</span> TCP connection established with <span class=\"token punctuation\">[</span>AF_INET<span class=\"token punctuation\">]</span><span class=\"token number\">92.222</span>.86.77:1194\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:39 <span class=\"token number\">2020</span> TCP_CLIENT <span class=\"token function\">link</span> local: <span class=\"token punctuation\">(</span>not bound<span class=\"token punctuation\">)</span>\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:39 <span class=\"token number\">2020</span> TCP_CLIENT <span class=\"token function\">link</span> remote: <span class=\"token punctuation\">[</span>AF_INET<span class=\"token punctuation\">]</span><span class=\"token number\">92.222</span>.86.77:1194\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:40 <span class=\"token number\">2020</span> <span class=\"token punctuation\">[</span>sputnik.gonzalonazareno.org<span class=\"token punctuation\">]</span> Peer Connection Initiated with <span class=\"token punctuation\">[</span>AF_INET<span class=\"token punctuation\">]</span><span class=\"token number\">92.222</span>.86.77:1194\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:41 <span class=\"token number\">2020</span> TUN/TAP device tun0 opened\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:41 <span class=\"token number\">2020</span> /sbin/ip <span class=\"token function\">link</span> <span class=\"token builtin class-name\">set</span> dev tun0 up mtu <span class=\"token number\">1500</span>\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:41 <span class=\"token number\">2020</span> /sbin/ip addr <span class=\"token function\">add</span> dev tun0 <span class=\"token builtin class-name\">local</span> <span class=\"token number\">172.23</span>.0.94 peer <span class=\"token number\">172.23</span>.0.93\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:41 <span class=\"token number\">2020</span> WARNING: this configuration may cache passwords <span class=\"token keyword\">in</span> memory -- use the auth-nocache option to prevent this\nWed Nov  <span class=\"token number\">4</span> <span class=\"token number\">19</span>:10:41 <span class=\"token number\">2020</span> Initialization Sequence Completed</code></pre></div>\n<ul>\n<li>Cuando hayas establecido la conexión VPN tendrás acceso a la red 172.22.0.0/16 a través de un túnel SSL. Compruébalo haciendo ping a 172.22.0.1</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@debian:/home/fran<span class=\"token comment\"># ping 172.22.0.1</span>\nPING <span class=\"token number\">172.22</span>.0.1 <span class=\"token punctuation\">(</span><span class=\"token number\">172.22</span>.0.1<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">172.22</span>.0.1: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">144</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">172.22</span>.0.1: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">88.8</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">172.22</span>.0.1: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">88.8</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">172.22</span>.0.1: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">4</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">93.5</span> ms\n^C\n--- <span class=\"token number\">172.22</span>.0.1 <span class=\"token function\">ping</span> statistics ---\n<span class=\"token number\">4</span> packets transmitted, <span class=\"token number\">4</span> received, <span class=\"token number\">0</span>% packet loss, <span class=\"token function\">time</span> 8ms\nrtt min/avg/max/mdev <span class=\"token operator\">=</span> <span class=\"token number\">88.801</span>/103.841/144.254/23.411 ms</code></pre></div>","timeToRead":4,"excerpt":"Configuración de cliente OpenVPN con certificados X.509 Para poder acceder a la red local desde el exterior, existe una red privada…","frontmatter":{"title":"Configuración de cliente OpenVPN con certificados X.509","cover":"https://img.icons8.com/ios/452/work.png","date":"2020-11-03T00:00:00.000Z","categories":["HLC"],"tags":["OpenVPN","Certificados"]},"fields":{"slug":"/configuracion-de-cliente-open-vpn-con-certificados-x-509","date":"November 02, 2020"}}},"pageContext":{"slug":"/configuracion-de-cliente-open-vpn-con-certificados-x-509","nexttitle":"Ejercicio 5: Control de acceso, autentificación y autorización","nextslug":"/ejercicio-5-control-de-acceso-autentificacion-y-autorizacion","prevtitle":"Servidor web nginx","prevslug":"/servidor-web-nginx"}}}