{"componentChunkName":"component---src-templates-post-js","path":"/sistemas-de-ficheros-avanzados-zfs-btrfs","result":{"data":{"markdownRemark":{"html":"<p>Elige uno de los dos sistemas de ficheros \"avanzados\".</p>\n<ul>\n<li>Crea un escenario que incluya una máquina y varios discos asociados a ella.</li>\n<li>Instala si es necesario el software de ZFS/Btrfs</li>\n<li>Gestiona los discos adicionales con ZFS/Btrfs</li>\n<li>Configura los discos en RAID, haciendo pruebas de fallo de algún disco y sustitución, restauración del RAID. Comenta ventajas e inconvenientes respecto al uso de RAID software con mdadm.</li>\n<li>Realiza ejercicios con pruebas de funcionamiento de las principales funcionalidades: compresión, cow, deduplicación, cifrado, etc.</li>\n</ul>\n<hr>\n<center><img alt=\"zfs\" src=\"https://magazine.odroid.com/wp-content/uploads/zfs.jpg\"></center>\nZFS es un sistema de archivos y administrador de vol&#xFA;menes desarrollado originalmente por Sun Microsystems para su sistema operativo Solaris. El significado original era &apos;Zettabyte File System&apos;, pero ahora es un acr&#xF3;nimo recursivo. \n<p>El anuncio oficial de ZFS se produjo en septiembre de 2004. El código fuente del producto final se integró en la rama principal de desarrollo de Solaris el 31 de octubre de 2005 y fue lanzado el 16 de noviembre de 2005 como parte de la compilación 27 de OpenSolaris.</p>\n<p>ZFS fue diseñado e implementado por un equipo de Sun liderado por Jeff Bonwick.</p>\n<p>ZFS destaca por su gran capacidad, integración de los conceptos anteriormente separados de sistema de ficheros y administrador de volúmenes en un solo producto, nueva estructura sobre el disco, sistemas de archivos ligeros y una administración de espacios de almacenamiento sencilla. </p>\n<p>Después de conocer un poco su historia comenzaremos a conocerlo un poco mejor como sistema de ficheros.</p>\n<h2 id=\"escenario\"><a href=\"#escenario\" aria-label=\"escenario permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Escenario</h2>\n<p><a href=\"/gatsbyjs/e41e03a7f851af8650a09d813f8c0fa2/vagrantfilezfs.txt\">Vagrantfile</a></p>\n<p>Crearemos un escenario en Vagrant al que le añadiremos 4 discos de 1GB.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/home/vagrant<span class=\"token comment\"># lsblk</span>\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span> <span class=\"token number\">19</span>.8G  <span class=\"token number\">0</span> disk \n├─sda1   <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span> <span class=\"token number\">18</span>.8G  <span class=\"token number\">0</span> part /\n├─sda2   <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>    1K  <span class=\"token number\">0</span> part \n└─sda5   <span class=\"token number\">8</span>:5    <span class=\"token number\">0</span> 1021M  <span class=\"token number\">0</span> part <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\nsdb      <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span> 1000M  <span class=\"token number\">0</span> disk \nsdc      <span class=\"token number\">8</span>:32   <span class=\"token number\">0</span> 1000M  <span class=\"token number\">0</span> disk \nsdd      <span class=\"token number\">8</span>:48   <span class=\"token number\">0</span> 1000M  <span class=\"token number\">0</span> disk \nsde      <span class=\"token number\">8</span>:64   <span class=\"token number\">0</span> 1000M  <span class=\"token number\">0</span> disk </code></pre></div>\n<hr>\n<h2 id=\"instalación-de-la-paquetería\"><a href=\"#instalaci%C3%B3n-de-la-paqueter%C3%ADa\" aria-label=\"instalación de la paquetería permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instalación de la paquetería.</h2>\n<p>Necesaría para la compilación de ZFS.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">vagrant@buster:~$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> build-essential autoconf automake libtool <span class=\"token function\">gawk</span> alien fakeroot ksh zlib1g-dev uuid-dev libattr1-dev libblkid-dev libselinux-dev libudev-dev libacl1-dev libaio-dev libdevmapper-dev libssl-dev libelf-dev\nvagrant@buster:~$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y linux-headers-<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">uname</span> -r<span class=\"token variable\">`</span></span> dkms</code></pre></div>\n<p>Descargamos ZFS del repositorio de GitHub.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">wget</span> https://github.com/zfsonlinux/zfs/releases/download/zfs-0.8.2/zfs-0.8.2.tar.gz</code></pre></div>\n<p>Descomprimimos y darmos permisos al directorio.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/home/vagrant<span class=\"token comment\"># ls</span>\nzfs-0.8.2.tar.gz\nroot@buster:/home/vagrant<span class=\"token comment\"># tar axf zfs-0.8.2.tar.gz</span>\nroot@buster:/home/vagrant<span class=\"token comment\"># cd zfs-0.8.2</span>\nroot@buster:/home/vagrant/zfs-0.8.2<span class=\"token comment\"># sudo chown -R root:root ./</span>\nroot@buster:/home/vagrant/zfs-0.8.2<span class=\"token comment\"># sudo chmod -R o-rwx ./</span></code></pre></div>\n<p>Configuramos nuestra instalación de Zfs.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/home/vagrant/zfs-0.8.2<span class=\"token comment\"># ./configure \\</span>\n<span class=\"token operator\">></span> --disable-systemd <span class=\"token punctuation\">\\</span>\n<span class=\"token operator\">></span> --enable-sysvinit <span class=\"token punctuation\">\\</span>\n<span class=\"token operator\">></span> --disable-debug <span class=\"token punctuation\">\\</span>\n<span class=\"token operator\">></span> --with-spec<span class=\"token operator\">=</span>generic <span class=\"token punctuation\">\\</span>\n<span class=\"token operator\">></span> --with-linux<span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ls</span> -1dtr /usr/src/linux-headers-*.*.*-common <span class=\"token operator\">|</span> <span class=\"token function\">tail</span> -n <span class=\"token number\">1</span><span class=\"token variable\">)</span></span> <span class=\"token punctuation\">\\</span>\n<span class=\"token operator\">></span> --with-linux-obj<span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ls</span> -1dtr /usr/src/linux-headers-*.*.*-amd64 <span class=\"token operator\">|</span> <span class=\"token function\">tail</span> -n <span class=\"token number\">1</span><span class=\"token variable\">)</span></span></code></pre></div>\n<p>Compilamos.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/home/vagrant/zfs-0.8.2<span class=\"token comment\"># make -j1 &amp;&amp; make install</span></code></pre></div>\n<p>Instalamos los script de inicio del servicio.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/home/vagrant/zfs-0.8.2<span class=\"token comment\"># cd /etc/init.d/</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># ln -s /usr/local/etc/init.d/zfs-import /etc/init.d/</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># ln -s /usr/local/etc/init.d/zfs-mount /etc/init.d/</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># ln -s /usr/local/etc/init.d/zfs-share /etc/init.d/</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># ln -s /usr/local/etc/init.d/zfs-zed /etc/init.d/</span></code></pre></div>\n<p>Habilitamos el servicio y activamos el modulo zfs.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/etc/init.d<span class=\"token comment\"># update-rc.d zfs-import defaults</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># update-rc.d zfs-mount defaults</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># update-rc.d zfs-share defaults</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># update-rc.d zfs-zed defaults</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># modprobe zfs</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># ldconfig</span></code></pre></div>\n<p>Comprobación</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/etc/init.d<span class=\"token comment\"># lsmod | grep zfs</span>\nzfs                  <span class=\"token number\">3760128</span>  <span class=\"token number\">0</span>\nzunicode              <span class=\"token number\">335872</span>  <span class=\"token number\">1</span> zfs\nzlua                  <span class=\"token number\">172032</span>  <span class=\"token number\">1</span> zfs\nzcommon                <span class=\"token number\">90112</span>  <span class=\"token number\">1</span> zfs\nznvpair                <span class=\"token number\">90112</span>  <span class=\"token number\">2</span> zfs,zcommon\nzavl                   <span class=\"token number\">16384</span>  <span class=\"token number\">1</span> zfs\nicp                   <span class=\"token number\">311296</span>  <span class=\"token number\">1</span> zfs\nspl                   <span class=\"token number\">114688</span>  <span class=\"token number\">5</span> zfs,icp,znvpair,zcommon,zavl</code></pre></div>\n<h2 id=\"gestiona-los-discos-con-zfs\"><a href=\"#gestiona-los-discos-con-zfs\" aria-label=\"gestiona los discos con zfs permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gestiona los discos con ZFS</h2>\n<p>Configuramos los disco en RAID, haciendo pruebas de fallo de disco, sustitución y restauración del RAID.</p>\n<h3 id=\"creamos-un-pool-con-raid-1\"><a href=\"#creamos-un-pool-con-raid-1\" aria-label=\"creamos un pool con raid 1 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creamos un pool con RAID 1.</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/etc/init.d<span class=\"token comment\"># zpool create -f RAID1 mirror /dev/sdb /dev/sdc /dev/sdd</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># sudo zpool status</span>\n  pool: RAID1\n state: ONLINE\n  scan: none requested\nconfig:\n\n\tNAME        STATE     READ WRITE CKSUM\n\tRAID1       ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t  mirror-0  ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdb     ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdc     ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdd     ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\nerrors: No known data errors</code></pre></div>\n<h3 id=\"añadimos-un-disco-de-reserva\"><a href=\"#a%C3%B1adimos-un-disco-de-reserva\" aria-label=\"añadimos un disco de reserva permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Añadimos un disco de reserva.</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/etc/init.d<span class=\"token comment\"># zpool add -f RAID1 spare /dev/sde</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># sudo zpool status</span>\n  pool: RAID1\n state: ONLINE\n  scan: none requested\nconfig:\n\n\tNAME        STATE     READ WRITE CKSUM\n\tRAID1       ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t  mirror-0  ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdb     ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdc     ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdd     ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\tspares\n\t  sde       AVAIL   \n\nerrors: No known data errors</code></pre></div>\n<h3 id=\"marcar-un-disco-como-fallido\"><a href=\"#marcar-un-disco-como-fallido\" aria-label=\"marcar un disco como fallido permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Marcar un disco como fallido.</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/etc/init.d<span class=\"token comment\"># zpool offline -f RAID1 /dev/sdd</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># sudo zpool status</span>\n  pool: RAID1\n state: DEGRADED\nstatus: One or <span class=\"token function\">more</span> devices are faulted <span class=\"token keyword\">in</span> response to persistent errors.\n\tSufficient replicas exist <span class=\"token keyword\">for</span> the pool to <span class=\"token builtin class-name\">continue</span> functioning <span class=\"token keyword\">in</span> a\n\tdegraded state.\naction: Replace the faulted device, or use <span class=\"token string\">'zpool clear'</span> to mark the device\n\trepaired.\n  scan: none requested\nconfig:\n\n\tNAME        STATE     READ WRITE CKSUM\n\tRAID1       DEGRADED     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t  mirror-0  DEGRADED     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdb     ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdc     ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdd     FAULTED      <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>  external device fault\n\tspares\n\t  sde       AVAIL   \n\nerrors: No known data errors</code></pre></div>\n<h3 id=\"reemplazar-disco-fallido-por-el-disco-que-tenemos-en-reserva\"><a href=\"#reemplazar-disco-fallido-por-el-disco-que-tenemos-en-reserva\" aria-label=\"reemplazar disco fallido por el disco que tenemos en reserva permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reemplazar disco fallido por el disco que tenemos en reserva.</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/etc/init.d<span class=\"token comment\"># zpool replace -f RAID1 /dev/sdd /dev/sde</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># sudo zpool status</span>\n  pool: RAID1\n state: DEGRADED\nstatus: One or <span class=\"token function\">more</span> devices are faulted <span class=\"token keyword\">in</span> response to persistent errors.\n\tSufficient replicas exist <span class=\"token keyword\">for</span> the pool to <span class=\"token builtin class-name\">continue</span> functioning <span class=\"token keyword\">in</span> a\n\tdegraded state.\naction: Replace the faulted device, or use <span class=\"token string\">'zpool clear'</span> to mark the device\n\trepaired.\n  scan: resilvered 286K <span class=\"token keyword\">in</span> <span class=\"token number\">0</span> days 00:00:00 with <span class=\"token number\">0</span> errors on Tue Feb  <span class=\"token number\">9</span> <span class=\"token number\">20</span>:24:30 <span class=\"token number\">2021</span>\nconfig:\n\n\tNAME         STATE     READ WRITE CKSUM\n\tRAID1        DEGRADED     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t  mirror-0   DEGRADED     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdb      ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdc      ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    spare-2  DEGRADED     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t      sdd    FAULTED      <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>  external device fault\n\t      sde    ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\tspares\n\t  sde        INUSE     currently <span class=\"token keyword\">in</span> use\n\nerrors: No known data errors</code></pre></div>\n<h3 id=\"restauración-del-disco-fallido\"><a href=\"#restauraci%C3%B3n-del-disco-fallido\" aria-label=\"restauración del disco fallido permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Restauración del disco fallido.</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/etc/init.d<span class=\"token comment\"># zpool clear RAID1 /dev/sdd</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># sudo zpool status</span>\n  pool: RAID1\n state: ONLINE\n  scan: resilvered 286K <span class=\"token keyword\">in</span> <span class=\"token number\">0</span> days 00:00:00 with <span class=\"token number\">0</span> errors on Tue Feb  <span class=\"token number\">9</span> <span class=\"token number\">20</span>:24:30 <span class=\"token number\">2021</span>\nconfig:\n\n\tNAME         STATE     READ WRITE CKSUM\n\tRAID1        ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t  mirror-0   ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdb      ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    sdc      ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t    spare-2  ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t      sdd    ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\t      sde    ONLINE       <span class=\"token number\">0</span>     <span class=\"token number\">0</span>     <span class=\"token number\">0</span>\n\tspares\n\t  sde        INUSE     currently <span class=\"token keyword\">in</span> use\n\nerrors: No known data errors</code></pre></div>\n<hr>\n<h2 id=\"funcionamiento-de-las-principales-funcionalidades\"><a href=\"#funcionamiento-de-las-principales-funcionalidades\" aria-label=\"funcionamiento de las principales funcionalidades permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Funcionamiento de las principales funcionalidades.</h2>\n<h3 id=\"compresión\"><a href=\"#compresi%C3%B3n\" aria-label=\"compresión permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compresión</h3>\n<p>Activamos el modo compresión que en su inicio esta off, activamos la compresión lz4 y comprobamos el estado de la compresión.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/etc/init.d<span class=\"token comment\"># zfs get compression RAID1</span>\nNAME   PROPERTY     VALUE     SOURCE\nRAID1  compression  off       default\nroot@buster:/etc/init.d<span class=\"token comment\"># zfs set compression=lz4 RAID1</span>\nroot@buster:/etc/init.d<span class=\"token comment\"># zfs get compression RAID1</span>\nNAME   PROPERTY     VALUE     SOURCE\nRAID1  compression  lz4       <span class=\"token builtin class-name\">local</span></code></pre></div>\n<p>Hagamos una prueba.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/RAID1<span class=\"token comment\"># mkdir complz4</span>\nroot@buster:/RAID1<span class=\"token comment\"># tar -cf /RAID1/complz4/prueba.tar /home/ /etc/</span>\ntar: Removing leading <span class=\"token variable\"><span class=\"token variable\">`</span>/' from member names\ntar: Removing leading <span class=\"token variable\">`</span></span>/' from hard <span class=\"token function\">link</span> targets\nroot@buster:/RAID1<span class=\"token comment\"># ls -lh /RAID1/complz4/prueba.tar </span>\n-rw-r--r-- <span class=\"token number\">1</span> root root 505M Feb <span class=\"token number\">11</span> 07:49 /RAID1/complz4/prueba.tar</code></pre></div>\n<p>Como podemos ver se ha agrupado /home y /etc en un directorio creado y se ha comprimido en .tar</p>\n<h3 id=\"cow---copy-on-write\"><a href=\"#cow---copy-on-write\" aria-label=\"cow   copy on write permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>COW - Copy on Write</h3>\n<p>Su función es el ahorro de espacio y capacidad en inodos a través de un tipo de copia diferencial. La version de OpenZfs actualmente en Debian Buster no tiene esta función completamente soportada.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/RAID1<span class=\"token comment\"># cp --reflink=always fich1 fich2</span>\ncp: failed to clone <span class=\"token string\">'fich2'</span> from <span class=\"token string\">'fich1'</span><span class=\"token builtin class-name\">:</span> Operation not supported</code></pre></div>\n<h3 id=\"deduplicación\"><a href=\"#deduplicaci%C3%B3n\" aria-label=\"deduplicación permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deduplicación</h3>\n<p>Bastante parecida a COW, es una función bastante interesante a la vez que util para el almacenamiento donde se eliminan los datos redundantes de los datos almacenados.</p>\n<p>En este caso volveremos a habilitar la deduplicación que se encuentra apagada.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/RAID1/complz4<span class=\"token comment\"># sudo zfs set dedup=on RAID1</span></code></pre></div>\n<p>Se realiza una copia del fichero .tar que anteriormente comprimimos.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/RAID1/complz4<span class=\"token comment\"># cp prueba.tar pruebadud.tar </span>\nroot@buster:/RAID1/complz4<span class=\"token comment\"># ls -lh</span>\ntotal 462M\n-rw-r--r-- <span class=\"token number\">1</span> root root 505M Feb <span class=\"token number\">11</span> 07:59 pruebadud.tar\n-rw-r--r-- <span class=\"token number\">1</span> root root 505M Feb <span class=\"token number\">11</span> 07:49 prueba.tar\nroot@buster:/RAID1/complz4<span class=\"token comment\"># zfs list</span>\nNAME    USED  AVAIL     REFER  MOUNTPOINT\nRAID1   463M   369M      462M  /RAID1</code></pre></div>\n<p>Como podemos observar la suma del peso de ambos archivos no corresponde al volumen de megas usados.</p>\n<h3 id=\"snapshots\"><a href=\"#snapshots\" aria-label=\"snapshots permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Snapshots</h3>\n<p>Un sistema de snapshots utilizado por Zfs, que nos permite recontruir imagenes anteriormente destruidas.</p>\n<p><strong>Creación/Destrución</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/RAID1<span class=\"token comment\"># zfs create RAID1/docs -o mountpoint=/docs</span>\nroot@buster:/RAID1<span class=\"token comment\"># zfs snapshot RAID1/docs@version1</span>\nroot@buster:/RAID1<span class=\"token comment\"># zfs list -t snapshot</span>\nNAME                  USED  AVAIL     REFER  MOUNTPOINT\nRAID1/docs@version1     0B      -       24K  -\nroot@buster:/RAID1<span class=\"token comment\"># zfs destroy RAID1/docs@version1</span>\nroot@buster:/RAID1<span class=\"token comment\"># zfs list -t snapshot</span>\nno datasets available</code></pre></div>\n<p><strong>RollBack</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@buster:/RAID1<span class=\"token comment\"># echo \"version 1\" > /docs/data.txt</span>\nroot@buster:/RAID1<span class=\"token comment\"># cat /docs/data.txt</span>\nversion <span class=\"token number\">1</span>\nroot@buster:/RAID1<span class=\"token comment\"># zfs snapshot RAID1/docs@version1</span>\nroot@buster:/RAID1<span class=\"token comment\"># zfs list -t snapshot</span>\nNAME                  USED  AVAIL     REFER  MOUNTPOINT\nRAID1/docs@version1     0B      -       24K  -\n\nroot@buster:/RAID1<span class=\"token comment\"># echo \"version 2\" > /docs/data.txt</span>\nroot@buster:/RAID1<span class=\"token comment\"># cat /docs/data.txt</span>\nversion <span class=\"token number\">2</span>\nroot@buster:/RAID1<span class=\"token comment\"># zfs list -t snapshot</span>\nNAME                  USED  AVAIL     REFER  MOUNTPOINT\nRAID1/docs@version1    14K      -       24K  -\nroot@buster:/RAID1<span class=\"token comment\"># zfs rollback RAID1/docs@version1</span>\nroot@buster:/RAID1<span class=\"token comment\"># cat /docs/data.txt</span>\nversion <span class=\"token number\">1</span></code></pre></div>\n<hr>\n<h2 id=\"conclusión\"><a href=\"#conclusi%C3%B3n\" aria-label=\"conclusión permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusión</h2>\n<p>En primer lugar comentar el tema de funcionalidad de este sistema de ficheros para servidores especialmente NAS donde la integridad de los archivos es uno de los aspectos más importantes, <strong>ZFS</strong> se diseñó desde un principio como un sistema que en la práctica será casi imposible alcanzar sus límites, con ello se logra un tiempo de vida a largo plazo, especialmente en servidores, ya que es muy costoso sustituirlos por otro nuevo, siendo necesario habitualmente hacer borrón y cuenta nueva.</p>\n<p>Dicho esto decir que <strong>ZFS</strong> esta condenado a su desuso por su incompatibilidad de licencias con <strong>CDDL</strong> y <strong>GPL</strong>, lo que hace que su uso no este tan expandido y desarrollado como su rival <strong>BTRFS</strong> que posee un desarrollo contínuo y licencia compatible con el kernel de linux.</p>","timeToRead":9,"excerpt":"Elige uno de los dos sistemas de ficheros \"avanzados\". Crea un escenario que incluya una máquina y varios discos asociados a ella. Instala…","frontmatter":{"title":"Sistemas de ficheros 'avanzados' ZFS/Btrfs","cover":"https://img.icons8.com/ios/452/work.png","date":"2021-01-27T00:00:00.000Z","categories":["HLC"],"tags":["ZFS/Btrfs","Sistemas de ficheros avanzados"]},"fields":{"slug":"/sistemas-de-ficheros-avanzados-zfs-btrfs","date":"January 26, 2021"}}},"pageContext":{"slug":"/sistemas-de-ficheros-avanzados-zfs-btrfs","nexttitle":"[ABD] - Gestión de Usuarios","nextslug":"/abd-gestion-de-usuarios","prevtitle":"[IAW] - Instalación de aplicación web python en OpenStack","prevslug":"/iaw-instalacion-de-aplicacion-web-python-en-open-stack"}}}