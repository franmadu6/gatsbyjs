{"componentChunkName":"component---src-templates-post-js","path":"/compilacion-de-un-kernel-linux-a-medida","result":{"data":{"markdownRemark":{"html":"<p>Al ser linux un kérnel libre, es posible descargar el código fuente, configurarlo y comprimirlo. Además, esta tarea a priori compleja, es más sencilla de lo que parece gracias a las herramientas disponibles.</p>\n<p>En esta tarea debes tratar de compilar un kérnel completamente funcional que reconozca todo el hardware básico de tu equipo y que sea a la vez lo más pequeño posible, es decir que incluya un vmlinuz lo más pequeño posible y que incorpore sólo los módulos imprescindibles. Para ello utiliza el método explicado en clase y entrega finalmente el fichero deb con el kérnel compilado por ti.</p>\n<p>El hardware básico incluye como mínimo el teclado, la interfaz de red y la consola gráfica (texto).</p>\n<h3 id=\"pasos-a-seguir\"><a href=\"#pasos-a-seguir\" aria-label=\"pasos a seguir permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pasos a seguir</h3>\n<p>Comprobaremos nuestra versión de kernel y la descargaremos:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel$ <span class=\"token function\">uname</span> -r\n<span class=\"token number\">4.19</span>.0-16-amd64\ndebian@fran:~/compilacionkernel$ <span class=\"token function\">wget</span> https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.19.tar.xz\n--2021-06-08 <span class=\"token number\">21</span>:33:35--  https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.19.tar.xz\nResolving mirrors.edge.kernel.org <span class=\"token punctuation\">(</span>mirrors.edge.kernel.org<span class=\"token punctuation\">)</span><span class=\"token punctuation\">..</span>. <span class=\"token number\">147.75</span>.101.1, <span class=\"token number\">2604</span>:1380:2001:3900::1\nConnecting to mirrors.edge.kernel.org <span class=\"token punctuation\">(</span>mirrors.edge.kernel.org<span class=\"token punctuation\">)</span><span class=\"token operator\">|</span><span class=\"token number\">147.75</span>.101.1<span class=\"token operator\">|</span>:443<span class=\"token punctuation\">..</span>. connected.\nHTTP request sent, awaiting response<span class=\"token punctuation\">..</span>. <span class=\"token number\">200</span> OK\nLength: <span class=\"token number\">103117552</span> <span class=\"token punctuation\">(</span>98M<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>application/x-xz<span class=\"token punctuation\">]</span>\nSaving to: ‘linux-4.19.tar.xz’\n\nlinux-4.19.tar.xz     <span class=\"token number\">100</span>%<span class=\"token punctuation\">[</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span>  <span class=\"token number\">98</span>.34M  <span class=\"token number\">5</span>.26MB/s    <span class=\"token keyword\">in</span> 23s     \n\n<span class=\"token number\">2021</span>-06-08 <span class=\"token number\">21</span>:33:59 <span class=\"token punctuation\">(</span><span class=\"token number\">4.25</span> MB/s<span class=\"token punctuation\">)</span> - ‘linux-4.19.tar.xz’ saved <span class=\"token punctuation\">[</span><span class=\"token number\">103117552</span>/103117552<span class=\"token punctuation\">]</span></code></pre></div>\n<p>Descomprimiremos y checkearemos su contenido:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel$ <span class=\"token function\">tar</span> xf linux-4.19.tar.xz\ndebian@fran:~/compilacionkernel$ <span class=\"token builtin class-name\">cd</span> linux-4.19/\ndebian@fran:~/compilacionkernel/linux-4.19$ \ndebian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">ls</span>\nCOPYING        Kconfig      README  crypto    include  lib      scripts   usr\nCREDITS        LICENSES     arch    drivers   init     mm       security  virt\nDocumentation  MAINTAINERS  block   firmware  ipc      net      sound\nKbuild         Makefile     certs   fs        kernel   samples  tools</code></pre></div>\n<p>Para realizarse la compilación se utiliza un fichero llamado <strong>.config</strong> que contiene la información de los componentes que se enlazaran y los que no. Para generar dicho fichero haremos uso del comando <strong>make oldconfig</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">make</span> oldconfig\n  HOSTCC  scripts/basic/fixdep\n  HOSTCC  scripts/kconfig/conf.o\n  YACC    scripts/kconfig/zconf.tab.c\n  LEX     scripts/kconfig/zconf.lex.c\n  HOSTCC  scripts/kconfig/zconf.tab.o\n  HOSTLD  scripts/kconfig/conf\nscripts/kconfig/conf  --oldconfig Kconfig\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># using defaults found in /boot/config-4.19.0-16-amd64</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># configuration written to .config</span>\n<span class=\"token comment\">#</span></code></pre></div>\n<p>Tras negar el enlace a varios componentes que no seran necesarios con el comando anteriormente comentado obtendremos el fichero <strong>.config</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">ls</span> -la <span class=\"token operator\">|</span> <span class=\"token function\">egrep</span> <span class=\"token string\">'.config'</span>\n-rw-r--r--   <span class=\"token number\">1</span> vagrant vagrant     <span class=\"token number\">59</span> Mar <span class=\"token number\">17</span> <span class=\"token number\">15</span>:43 .cocciconfig\n-rw-r--r--   <span class=\"token number\">1</span> vagrant vagrant <span class=\"token number\">206240</span> Jun  <span class=\"token number\">8</span> <span class=\"token number\">20</span>:15 .config\n-rw-r--r--   <span class=\"token number\">1</span> vagrant vagrant    <span class=\"token number\">563</span> Mar <span class=\"token number\">17</span> <span class=\"token number\">15</span>:43 Kconfig</code></pre></div>\n<p>Comprobaremos la cantidad de componentes enlazados estáticamente(y) y dinámicamente(m) de nuestra configuración actual.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">egrep</span> <span class=\"token string\">'=y'</span> .config <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l\n<span class=\"token number\">2016</span>\ndebian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">egrep</span> <span class=\"token string\">'=m'</span> .config <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l\n<span class=\"token number\">3381</span></code></pre></div>\n<p>Son mas de 5000 elementos los que poseemos ahora mismo en nuestra configuración, para rebajarlos de manera significativa haremos uso del comando <strong>make localmodconfig</strong> que comprobará los componentes que se estan usando actualmente descartando el resto modificando así nuestro <strong>.config</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">make</span> localmodconfig\nusing config: <span class=\"token string\">'.config'</span>\nvboxsf config not found<span class=\"token operator\">!</span><span class=\"token operator\">!</span>\nSystem keyring enabled but keys <span class=\"token string\">\"debian/certs/debian-uefi-certs.pem\"</span> not found. Resetting keys to default value.\n*\n* Restart config<span class=\"token punctuation\">..</span>.\n*\n*\n* PCI GPIO expanders\n*\nAMD <span class=\"token number\">8111</span> GPIO driver <span class=\"token punctuation\">(</span>GPIO_AMD8111<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>N/m/y/?<span class=\"token punctuation\">]</span> n\nBT8XX GPIO abuser <span class=\"token punctuation\">(</span>GPIO_BT8XX<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>N/m/y/?<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>NEW<span class=\"token punctuation\">)</span> n\nOKI SEMICONDUCTOR ML7213 IOH GPIO support <span class=\"token punctuation\">(</span>GPIO_ML_IOH<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>N/m/y/?<span class=\"token punctuation\">]</span> n\nACCES PCI-IDIO-16 GPIO support <span class=\"token punctuation\">(</span>GPIO_PCI_IDIO_16<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>N/m/y/?<span class=\"token punctuation\">]</span> n\nACCES PCIe-IDIO-24 GPIO support <span class=\"token punctuation\">(</span>GPIO_PCIE_IDIO_24<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>N/m/y/?<span class=\"token punctuation\">]</span> n\nRDC R-321x GPIO support <span class=\"token punctuation\">(</span>GPIO_RDC321X<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>N/m/y/?<span class=\"token punctuation\">]</span> n\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># configuration written to .config</span>\n<span class=\"token comment\">#</span></code></pre></div>\n<p>Nota: Para solucionar el error 'System keyring enabled but keys \"debian/certs/debian-uefi-certs.pem\" not found. Resetting keys to default value.' deberemos comentar la siguiente linea en nuestro archivo <strong>.config</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">sed</span> -ri <span class=\"token string\">'/CONFIG_SYSTEM_TRUSTED_KEYS/s/=.+/=\"\"/g'</span> .config</code></pre></div>\n<p>Una vez realizado el comando <strong>make localmodconfig</strong> podemos comprobrar que satisfactoriamente hemos reducido la cantidad de componente necesarios de mas de 5000 a al menos de 1550 componentes.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">egrep</span> <span class=\"token string\">'=y'</span> .config <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l\n<span class=\"token number\">1325</span>\ndebian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">egrep</span> <span class=\"token string\">'=m'</span> .config <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l\n<span class=\"token number\">193</span></code></pre></div>\n<p>Con el comando <strong>nproc</strong> podremos ver la cantidad de hilos existentes que nos haran falta saber para la implementación del siguiente comando:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ nproc\n<span class=\"token number\">2</span></code></pre></div>\n<p>Ya podríamos compilar dicho kernel con el comando <strong>make -j 'numero de hilos' bindeb-pkg</strong> construyendo asi un paquete <strong>.deb</strong> para que pudiéramos instalarlo en nuestra máquina:</p>\n<p>Nota: Paquetería necesaria <strong>sudo apt install libelf-dev libssl-dev</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">make</span> -j2 bindeb-pkg\n/bin/bash ./scripts/package/mkdebian\ndpkg-buildpackage -r<span class=\"token string\">\"fakeroot -u\"</span> -a<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> debian/arch<span class=\"token variable\">)</span></span> -b -nc -uc\ndpkg-buildpackage: info: <span class=\"token builtin class-name\">source</span> package linux-4.19.181\ndpkg-buildpackage: info: <span class=\"token builtin class-name\">source</span> version <span class=\"token number\">4.19</span>.181-1\ndpkg-buildpackage: info: <span class=\"token builtin class-name\">source</span> distribution buster\ndpkg-buildpackage: info: <span class=\"token builtin class-name\">source</span> changed by vagrant <span class=\"token operator\">&lt;</span>debian@fran<span class=\"token operator\">></span>\ndpkg-buildpackage: info: <span class=\"token function\">host</span> architecture amd64</code></pre></div>\n<p>Podemos comprobar el tamaño del paquete <strong>.deb</strong> que posee el kernel.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">du</span> -hs <span class=\"token punctuation\">..</span>/linux-image-4.19.181_4.19.181-1_amd64.deb \n13M\tlinux-image-4.19.181_4.19.181-1_amd64.deb</code></pre></div>\n<p>En este momento ya tendriamos compilado nuesto kernel, pero queremos descargarlo un poco mas y hacerlo mas liviano.</p>\n<p>Para ello borraremos lo echo anteriormente:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">make</span> clean</code></pre></div>\n<p>Y generamos un nuevo fichero <strong>.config</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">make</span> localmodconfig</code></pre></div>\n<p>Deberemos reducirlo lo máximo posible quitando así funcionalidades para ello haremos uso del comando <strong>make xconfig</strong>.</p>\n<p>Nota: No sin antes instalar <strong>sudo apt install pkg-config</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">make</span> xconfig</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 690px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsbyjs/static/57e0bcc1a436c55ec2247bb88fec68f8/ca9ca/xconfig-kernel.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.40449438202246%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAB60lEQVQ4y31Ty47aQBD0V2cFJ0Acga/JKafksIoUKZccQgQGO2DMw2ZtHrbB2FOZ6uygWWfJSCUGd0919ctptVrq6ekD2u226nQ6sNHtdjEYDDAcDjEajeTOb00f/vZ6PfT7fThRFGG326gkSXG9XtE8SimUZYnT6YS6rvG/Q18njmPlui6m06nyPE+T75AkieByueB2u0mg9XqNxWIh0G9wPB4lEO02HBrc2QzBaqUdI8Ra8fl8RqaR5znqqpLo+/0L5vO5YKV9t9utBDTKzHE+/fDx8dsYn38G+OolePZSPPvp31/9/8vsBd9/71FqlZUmpwoSGBhCAyc9Zfg1ceEtlhorpOcCRVkju1bINXg/ZjluOr1HdXtDGEc7TCcTRLp2TBPq38JTXflK2FTXPA5rM9GEYbjG4XBAlmXSTWXVhrWqXmv5SNldIYurOyzd472pxBBuNhtwxAg2sigKsTM4gxnIHFIhR6G06mQT8nEYhkLKoGmaCkxGdqcdOo3HY3lAQgPbiYScTwYlCceJRBwve3QkZQ4t0+V8US2dTTo2YRAEYufGvNfp+6bwQpVMm8Scs/dSNnZuDGv4sCksJKOzMb7vY7lc6q3Yv9lbpsVvJDK1e7TX95RJxrqY/eQDGR8dlQqNcnOMvYk/wztszL2/OvcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PracticaImg\"\n        title=\"imagen del uso de xconfig\"\n        src=\"/gatsbyjs/static/57e0bcc1a436c55ec2247bb88fec68f8/36727/xconfig-kernel.png\"\n        srcset=\"/gatsbyjs/static/57e0bcc1a436c55ec2247bb88fec68f8/acf4b/xconfig-kernel.png 173w,\n/gatsbyjs/static/57e0bcc1a436c55ec2247bb88fec68f8/fc834/xconfig-kernel.png 345w,\n/gatsbyjs/static/57e0bcc1a436c55ec2247bb88fec68f8/36727/xconfig-kernel.png 690w,\n/gatsbyjs/static/57e0bcc1a436c55ec2247bb88fec68f8/17fa4/xconfig-kernel.png 1035w,\n/gatsbyjs/static/57e0bcc1a436c55ec2247bb88fec68f8/ca9ca/xconfig-kernel.png 1335w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>El uso de la interfaz dada por xconfig es sencillo:<br>\nlos marcados con un · son módulos, los marcados con ✓ son estáticos y los que no están marcados, no serán añadidos a la compilación.  </p>\n<p>Cuando hayamos finalizado la configuración pulsamos el disquete para guardar los cambios.</p>\n<p>Despues de ir reduciendo tediosamente los componentes he llegado al siguiente punto:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">fran@debian:~/compilacionkernel/linux-4.19$ <span class=\"token function\">grep</span> <span class=\"token string\">\"=y\"</span> .config<span class=\"token operator\">|</span><span class=\"token function\">wc</span> -l\n<span class=\"token number\">725</span>\nfran@debian:~/compilacionkernel/linux-4.19$ <span class=\"token function\">grep</span> <span class=\"token string\">\"=m\"</span> .config<span class=\"token operator\">|</span><span class=\"token function\">wc</span> -l\n<span class=\"token number\">87</span></code></pre></div>\n<p>Con un antiguo <strong>make localmodconfig</strong> llegamos a:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">egrep</span> <span class=\"token string\">'=y'</span> .config <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l\n<span class=\"token number\">1325</span>\ndebian@fran:~/compilacionkernel/linux-4.19$ <span class=\"token function\">egrep</span> <span class=\"token string\">'=m'</span> .config <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l\n<span class=\"token number\">193</span></code></pre></div>\n<p>Por lo que hemos bajado aun mas los componentes necesarios para nuestro <strong>kernel a medida</strong> a menos de 1000!.</p>","timeToRead":5,"excerpt":"Al ser linux un kérnel libre, es posible descargar el código fuente, configurarlo y comprimirlo. Además, esta tarea a priori compleja, es…","frontmatter":{"title":"Compilación de un kérnel linux a medida","cover":"https://img.icons8.com/ios/452/work.png","date":"2020-11-15T00:00:00.000Z","categories":["ASO"],"tags":["Kernel","Linux"]},"fields":{"slug":"/compilacion-de-un-kernel-linux-a-medida","date":"November 14, 2020"}}},"pageContext":{"slug":"/compilacion-de-un-kernel-linux-a-medida","nexttitle":"Tarea OVH. Lemp","nextslug":"/tarea-ovh-lemp","prevtitle":"Instalación y configuración inicial de los servidores","prevslug":"/instalacion-y-configuracion-inicial-de-los-servidores"}}}