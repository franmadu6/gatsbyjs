{"componentChunkName":"component---src-templates-post-js","path":"/sad-practica-vpn-con-open-vpn-y-certificados-x-509","result":{"data":{"markdownRemark":{"html":"<h2 id=\"tarea-1-vpn-de-acceso-remoto-con-openvpn-y-certificados-x509permalink\"><a href=\"#tarea-1-vpn-de-acceso-remoto-con-openvpn-y-certificados-x509permalink\" aria-label=\"tarea 1 vpn de acceso remoto con openvpn y certificados x509permalink permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tarea 1: VPN de acceso remoto con OpenVPN y certificados x509Permalink</h2>\n<h3 id=\"para-esta-tarea-puedes-usar-el-fichero-heat-del-primer-ejercicio-en-esta-tarea-vas-a-realizar-el-segundo-ejercicio-del-tema\"><a href=\"#para-esta-tarea-puedes-usar-el-fichero-heat-del-primer-ejercicio-en-esta-tarea-vas-a-realizar-el-segundo-ejercicio-del-tema\" aria-label=\"para esta tarea puedes usar el fichero heat del primer ejercicio en esta tarea vas a realizar el segundo ejercicio del tema permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Para esta tarea puedes usar el fichero heat del primer ejercicio. En esta tarea vas a realizar el segundo ejercicio del tema:</h3>\n<h3 id=\"configura-una-conexión-vpn-de-acceso-remoto-entre-dos-equipos\"><a href=\"#configura-una-conexi%C3%B3n-vpn-de-acceso-remoto-entre-dos-equipos\" aria-label=\"configura una conexión vpn de acceso remoto entre dos equipos permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configura una conexión VPN de acceso remoto entre dos equipos:</h3>\n<ul>\n<li>\n<h3 id=\"uno-de-los-dos-equipos-el-que-actuará-como-servidor-estará-conectado-a-dos-redes\"><a href=\"#uno-de-los-dos-equipos-el-que-actuar%C3%A1-como-servidor-estar%C3%A1-conectado-a-dos-redes\" aria-label=\"uno de los dos equipos el que actuará como servidor estará conectado a dos redes permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Uno de los dos equipos (el que actuará como servidor) estará conectado a dos redes</h3>\n</li>\n<li>\n<h3 id=\"para-la-autenticación-de-los-extremos-se-usarán-obligatoriamente-certificados-digitales-que-se-generarán-utilizando-openssl-y-se-almacenarán-en-el-directorio-etcopenvpn-junto-con-los-parámetros-diffie-helman-y-el-certificado-de-la-propia-autoridad-de-certificación\"><a href=\"#para-la-autenticaci%C3%B3n-de-los-extremos-se-usar%C3%A1n-obligatoriamente-certificados-digitales-que-se-generar%C3%A1n-utilizando-openssl-y-se-almacenar%C3%A1n-en-el-directorio-etcopenvpn-junto-con-los-par%C3%A1metros-diffie-helman-y-el-certificado-de-la-propia-autoridad-de-certificaci%C3%B3n\" aria-label=\"para la autenticación de los extremos se usarán obligatoriamente certificados digitales que se generarán utilizando openssl y se almacenarán en el directorio etcopenvpn junto con los parámetros diffie helman y el certificado de la propia autoridad de certificación permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.</h3>\n</li>\n<li>\n<h3 id=\"se-utilizarán-direcciones-de-la-red-109999024-para-las-direcciones-virtuales-de-la-vpn-la-dirección-1099991-se-asignará-al-servidor-vpn\"><a href=\"#se-utilizar%C3%A1n-direcciones-de-la-red-109999024-para-las-direcciones-virtuales-de-la-vpn-la-direcci%C3%B3n-1099991-se-asignar%C3%A1-al-servidor-vpn\" aria-label=\"se utilizarán direcciones de la red 109999024 para las direcciones virtuales de la vpn la dirección 1099991 se asignará al servidor vpn permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN. La dirección 10.99.99.1 se asignará al servidor VPN.</h3>\n</li>\n<li>\n<h3 id=\"los-ficheros-de-configuración-del-servidor-y-del-cliente-se-crearán-en-el-directorio-etcopenvpn-de-cada-máquina-y-se-llamarán-servidorconf-y-clienteconf-respectivamente-la-configuración-establecida-debe-cumplir-los-siguientes-aspectos\"><a href=\"#los-ficheros-de-configuraci%C3%B3n-del-servidor-y-del-cliente-se-crear%C3%A1n-en-el-directorio-etcopenvpn-de-cada-m%C3%A1quina-y-se-llamar%C3%A1n-servidorconf-y-clienteconf-respectivamente-la-configuraci%C3%B3n-establecida-debe-cumplir-los-siguientes-aspectos\" aria-label=\"los ficheros de configuración del servidor y del cliente se crearán en el directorio etcopenvpn de cada máquina y se llamarán servidorconf y clienteconf respectivamente la configuración establecida debe cumplir los siguientes aspectos permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Los ficheros de configuración del servidor y del cliente se crearán en el directorio /etc/openvpn de cada máquina, y se llamarán servidor.conf y cliente.conf respectivamente. La configuración establecida debe cumplir los siguientes aspectos:</h3>\n<ul>\n<li><strong>El demonio openvpn se manejará con systemctl.</strong></li>\n<li><strong>Se debe configurar para que la comunicación esté comprimida.</strong></li>\n<li><strong>La asignación de direcciones IP será dinámica.</strong></li>\n<li><strong>Existirá un fichero de log en el equipo.</strong></li>\n<li><strong>Se mandarán a los clientes las rutas necesarias.</strong></li>\n</ul>\n</li>\n<li>\n<h3 id=\"tras-el-establecimiento-de-la-vpn-la-máquina-cliente-debe-ser-capaz-de-acceder-a-una-máquina-que-esté-en-la-otra-red-a-la-que-está-conectado-el-servidor\"><a href=\"#tras-el-establecimiento-de-la-vpn-la-m%C3%A1quina-cliente-debe-ser-capaz-de-acceder-a-una-m%C3%A1quina-que-est%C3%A9-en-la-otra-red-a-la-que-est%C3%A1-conectado-el-servidor\" aria-label=\"tras el establecimiento de la vpn la máquina cliente debe ser capaz de acceder a una máquina que esté en la otra red a la que está conectado el servidor permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tras el establecimiento de la VPN, la máquina cliente debe ser capaz de acceder a una máquina que esté en la otra red a la que está conectado el servidor.</h3>\n</li>\n<li>\n<h3 id=\"instala-el-complemento-de-vpn-en-networkmanager-y-configura-el-cliente-de-forma-gráfica-desde-este-complemento\"><a href=\"#instala-el-complemento-de-vpn-en-networkmanager-y-configura-el-cliente-de-forma-gr%C3%A1fica-desde-este-complemento\" aria-label=\"instala el complemento de vpn en networkmanager y configura el cliente de forma gráfica desde este complemento permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instala el complemento de VPN en networkmanager y configura el cliente de forma gráfica desde este complemento.</h3>\n</li>\n</ul>\n<hr>\n<ul>\n<li>Escenario utilizado ➜ <a href=\"/gatsbyjs/d180c6a6aa5a58256a336f5f4fe9afd4/vagrantfilevpn.txt\">Vagrantfile</a></li>\n<li>Antes de comenzar deberemos tener ➜ <a href=\"content/2020-11-03-openvpn-cert.md\">Autoridad Certificadora y Certificados.</a></li>\n</ul>\n<h2 id=\"cliente1\"><a href=\"#cliente1\" aria-label=\"cliente1 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cliente1</h2>\n<p>Instalamos el paquete <strong>OpenVPN</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">vagrant@Cliente1:~$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> openvpn</code></pre></div>\n<p>Crearemos un certificado para enviarselo a la unidad certificadora.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Cliente1:~/ca<span class=\"token comment\"># openssl req -new -key /etc/ssl/private/maduvpn.key -out /root/maduvpn.csr</span>\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter <span class=\"token string\">'.'</span>, the field will be left blank.\n-----\nCountry Name <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> letter code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>AU<span class=\"token punctuation\">]</span>:ES\nState or Province Name <span class=\"token punctuation\">(</span>full name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Some-State<span class=\"token punctuation\">]</span>:Sevilla\nLocality Name <span class=\"token punctuation\">(</span>eg, city<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:Dos Hermanas\nOrganization Name <span class=\"token punctuation\">(</span>eg, company<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Internet Widgits Pty Ltd<span class=\"token punctuation\">]</span>:IES Gonzalo Nazareno\nOrganizational Unit Name <span class=\"token punctuation\">(</span>eg, section<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:Informatica\nCommon Name <span class=\"token punctuation\">(</span>e.g. server FQDN or YOUR name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:Francisco Javier Madueñpo Jurado\nEmail Address <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:frandh1997@gmail.com\n\nPlease enter the following <span class=\"token string\">'extra'</span> attributes\nto be sent with your certificate request\nA challenge password <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:\nAn optional company name <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>:</code></pre></div>\n<p>Una vez enviado esperaremos a que nos lo devuelva, una vez devuelto moveremos los certificados y la clave privada a /etc/openvpn/client</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\">#desde el servidor</span>\nroot@Servidor:~/ca<span class=\"token comment\"># openssl x509 -req -in /home/vagrant/maduvpn.csr -CA certs/ca.cert.pem -CAkey private/ca.key.pem -CAcreateserial -out maduvpnfirmado.crt</span>\nSignature ok\n<span class=\"token assign-left variable\">subject</span><span class=\"token operator\">=</span>C <span class=\"token operator\">=</span> ES, ST <span class=\"token operator\">=</span> Sevilla, L <span class=\"token operator\">=</span> Dos Hermanas, O <span class=\"token operator\">=</span> IES Gonzalo Nazareno, OU <span class=\"token operator\">=</span> Informatica, CN <span class=\"token operator\">=</span> Francisco Javier Madue<span class=\"token punctuation\">\\</span>C3<span class=\"token punctuation\">\\</span><span class=\"token number\">83</span><span class=\"token punctuation\">\\</span>C2<span class=\"token punctuation\">\\</span>B1po Jurado, emailAddress <span class=\"token operator\">=</span> frandh1997@gmail.com\nGetting CA Private Key\nEnter pass phrase <span class=\"token keyword\">for</span> private/ca.key.pem:</code></pre></div>\n<h2 id=\"servidor\"><a href=\"#servidor\" aria-label=\"servidor permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Servidor</h2>\n<p>Instalamos el paquete <strong>OpenVPN</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">vagrant@Servidor:~$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> openvpn</code></pre></div>\n<p>Utilizando dhparam crearemos la clave Diffie-Hellman.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">vagrant@Servidor:~$ <span class=\"token builtin class-name\">cd</span> /etc/openvpn/\nvagrant@Servidor:/etc/openvpn$ <span class=\"token function\">sudo</span> openssl dhparam -out dhparams.pem <span class=\"token number\">4096</span>\nGenerating DH parameters, <span class=\"token number\">4096</span> bit long safe prime, generator <span class=\"token number\">2</span>\nThis is going to take a long <span class=\"token function\">time</span>\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></code></pre></div>\n<p>Activamos el bit de forward para permitr el tráfico.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Servidor:/etc/openvpn<span class=\"token comment\"># echo 1 > /proc/sys/net/ipv4/ip_forward</span></code></pre></div>\n<p>Crearemos un fichero de configuración para <strong>OpenVPN</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Servidor:/etc/openvpn<span class=\"token comment\"># nano /etc/openvpn/servidor.conf</span>\ndev tun\nserver <span class=\"token number\">10.99</span>.99.0 <span class=\"token number\">255.255</span>.255.0 \npush <span class=\"token string\">\"route 10.10.10.0 255.255.255.0\"</span>\ntls-server\ndh /etc/openvpn/dhparams.pem\nca /root/ca/certs/ca.cert.pem\ncert /etc/openvpn/serverVPN.crt \nkey /etc/ssl/private/servidorvpn.key\ncomp-lzo\nkeepalive <span class=\"token number\">10</span> <span class=\"token number\">60</span>\nverb <span class=\"token number\">3</span>\naskpass /etc/openvpn/pass.txt</code></pre></div>\n<p>Generaremos un fichero para guardar contraseñas y se reconocido por el parámetro <strong>askpass</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Servidor:/etc/openvpn<span class=\"token comment\"># touch pass.txt</span>\nroot@Servidor:/etc/openvpn<span class=\"token comment\"># echo \"fran\" > pass.txt</span></code></pre></div>\n<p>Descomentaremos las siguiente linea para que openvpn reconozca systemd(ficheros de configuración).</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Servidor:/etc/openvpn<span class=\"token comment\"># nano /etc/default/openvpn</span>\n<span class=\"token assign-left variable\">AUTOSTART</span><span class=\"token operator\">=</span><span class=\"token string\">\"all\"</span></code></pre></div>\n<p>Reiniciamos servicio y comprobamos su estado.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Servidor:/etc/openvpn<span class=\"token comment\"># systemctl restart openvpn.service</span>\nroot@Servidor:/etc/openvpn<span class=\"token comment\"># systemctl status openvpn.service</span>\n● openvpn.service - OpenVPN <span class=\"token function\">service</span>\n   Loaded: loaded <span class=\"token punctuation\">(</span>/lib/systemd/system/openvpn.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: enabled<span class=\"token punctuation\">)</span>\n   Active: active <span class=\"token punctuation\">(</span>exited<span class=\"token punctuation\">)</span> since Mon <span class=\"token number\">2021</span>-03-22 <span class=\"token number\">11</span>:56:28 UTC<span class=\"token punctuation\">;</span> 8s ago\n  Process: <span class=\"token number\">1549</span> <span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/bin/true <span class=\"token punctuation\">(</span>code<span class=\"token operator\">=</span>exited, <span class=\"token assign-left variable\">status</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>/SUCCESS<span class=\"token punctuation\">)</span>\n Main PID: <span class=\"token number\">1549</span> <span class=\"token punctuation\">(</span>code<span class=\"token operator\">=</span>exited, <span class=\"token assign-left variable\">status</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>/SUCCESS<span class=\"token punctuation\">)</span>\n\nMar <span class=\"token number\">22</span> <span class=\"token number\">11</span>:56:28 Servidor systemd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>: Starting OpenVPN service<span class=\"token punctuation\">..</span>.\nMar <span class=\"token number\">22</span> <span class=\"token number\">11</span>:56:28 Servidor systemd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>: Started OpenVPN service.</code></pre></div>\n<h2 id=\"cliente-2\"><a href=\"#cliente-2\" aria-label=\"cliente 2 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cliente 2</h2>\n<p>Eliminaremos la tabla de enrutamiento por defecto y le añadiremos la direccion priuvada de nuestro servidor.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">vagrant@Cliente2:~$ <span class=\"token function\">sudo</span> <span class=\"token function\">ip</span> r del default\nvagrant@Cliente2:~$ <span class=\"token function\">sudo</span> <span class=\"token function\">ip</span> r <span class=\"token function\">add</span> default via <span class=\"token number\">192.168</span>.100.10</code></pre></div>\n<h2 id=\"cliente-1\"><a href=\"#cliente-1\" aria-label=\"cliente 1 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cliente 1</h2>\n<p>Ahora con los dos certificados, crearemos el fichero de configuración del cliente.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Cliente1:/etc/openvpn<span class=\"token comment\"># nano vpn.conf</span>\ndev tun\nremote <span class=\"token number\">172.22</span>.3.32\n<span class=\"token function\">ifconfig</span> <span class=\"token number\">10.99</span>.99.0 <span class=\"token number\">255.255</span>.255.0\npull\ntls-client\nca /etc/openvpn/client/ca.cert.pem\ncert /etc/openvpn/client/maduvpnfirmado.crt\nkey /etc/openvpn/client/maduvpn.key\ncomp-lzo\nkeepalive <span class=\"token number\">10</span> <span class=\"token number\">60</span>\nverb <span class=\"token number\">3</span>\naskpass /etc/openvpn/client/pass.txt</code></pre></div>\n<p>Volveremos a generar un fichero para <strong>askpass</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Cliente1:/etc/openvpn<span class=\"token comment\"># touch pass.txt</span>\nroot@Cliente1:/etc/openvpn<span class=\"token comment\"># echo \"fran\" > pass.txt</span></code></pre></div>\n<p>Volvewremos a descomentar las lineas del fichero etc/default/openvpn esta vez del cliente.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Cliente1:/etc/openvpn<span class=\"token comment\"># nano /etc/default/openvpn</span>\n<span class=\"token assign-left variable\">AUTOSTART</span><span class=\"token operator\">=</span><span class=\"token string\">\"all\"</span></code></pre></div>\n<p>Reiniciaremos el servicio.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@Cliente1:/etc/openvpn<span class=\"token comment\"># systemctl restart openvpn.service</span></code></pre></div>\n<p>Realizaremos un ip a para comprobar que la interfaz tun ha sido generada.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"></code></pre></div>","timeToRead":6,"excerpt":"Tarea 1: VPN de acceso remoto con OpenVPN y certificados x509Permalink Para esta tarea puedes usar el fichero heat del primer ejercicio. En…","frontmatter":{"title":"[SAD] - Práctica: VPN con OpenVPN y certificados x509","cover":"https://img.icons8.com/ios/452/work.png","date":"2021-03-17T00:00:00.000Z","categories":["SAD"],"tags":["VPN","OpenVPN"]},"fields":{"slug":"/sad-practica-vpn-con-open-vpn-y-certificados-x-509","date":"March 16, 2021"}}},"pageContext":{"slug":"/sad-practica-vpn-con-open-vpn-y-certificados-x-509","nexttitle":"[ABD] Práctica 7 - Auditorías","nextslug":"/abd-practica-7-auditorias","prevtitle":"Práctica 2: rclone - Gestionando nuestro almacenamiento en la nube (unidad 1)","prevslug":"/practica-2-rclone-gestionando-nuestro-almacenamiento-en-la-nube-unidad-1"}}}