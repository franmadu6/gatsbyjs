{"componentChunkName":"component---src-templates-post-js","path":"/lda-ps","result":{"data":{"markdownRemark":{"html":"<h2 id=\"configura-el-servidor-ldap-de-frestón-para-que-utilice-el-protocolo-ldaps-a-la-vez-que-el-ldap-utilizando-el-certificado-x509-de-la-práctica-de-https-o-solicitando-el-correspondiente-a-través-de-gestiona-realiza-las-modificaciones-adecuadas-en-el-cliente-ldap-de-frestón-para-que-todas-las-consultas-se-realicen-por-defecto-utilizando-ldaps\"><a href=\"#configura-el-servidor-ldap-de-frest%C3%B3n-para-que-utilice-el-protocolo-ldaps-a-la-vez-que-el-ldap-utilizando-el-certificado-x509-de-la-pr%C3%A1ctica-de-https-o-solicitando-el-correspondiente-a-trav%C3%A9s-de-gestiona-realiza-las-modificaciones-adecuadas-en-el-cliente-ldap-de-frest%C3%B3n-para-que-todas-las-consultas-se-realicen-por-defecto-utilizando-ldaps\" aria-label=\"configura el servidor ldap de frestón para que utilice el protocolo ldaps a la vez que el ldap utilizando el certificado x509 de la práctica de https o solicitando el correspondiente a través de gestiona realiza las modificaciones adecuadas en el cliente ldap de frestón para que todas las consultas se realicen por defecto utilizando ldaps permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configura el servidor LDAP de frestón para que utilice el protocolo ldaps:// a la vez que el ldap:// utilizando el certificado x509 de la práctica de https o solicitando el correspondiente a través de gestiona. Realiza las modificaciones adecuadas en el cliente ldap de frestón para que todas las consultas se realicen por defecto utilizando ldaps://</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 690px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/gatsbyjs/static/aa4da7e86955fac0bd7dfbc4f6f778ad/73d01/ldap-over-ssl-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.730279898218825%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABQUlEQVQY03WPXUsCQRiF/RNF0K+pH1JQpOBVF0JfdCEYRSTSTeUayUJQmxcZmSWxiMbqRab5sZK0prJftoRGEA07OzONbhSEe2Au5sw87zmvixACANA0DUJTEO4k6Zk61WoFQiiKtUbjiV4xxmSUXPSoqhKNHlIsEPCHw3uZTNrtniuViptbGx7PfKfTpn8QQk6wGgxu53ICw+xz3InPt+j1LoRCO6trS7EYB97KBGjDaDwCBuCLZY94/jYSOUilrmmyosipmys+LeD3ApaP0QuDgYEH/REe6g8eLTzoCSsrqM0icR3Jp7/mf5iuRC00FP4RwZYJE5MwO2UmJsjDbEvpPRbvm02p3+/ZI5yS7R0hjI9b2WnzYowUZsr1Vvz8LJm8zOdzdp5zbbultIvqfqu2TPTEx6ep66phvHa7Xfv5G0SZqN7RvJ23AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"PracticaImg\"\n        title=\"ldaps logo\"\n        src=\"/gatsbyjs/static/aa4da7e86955fac0bd7dfbc4f6f778ad/36727/ldap-over-ssl-1.png\"\n        srcset=\"/gatsbyjs/static/aa4da7e86955fac0bd7dfbc4f6f778ad/acf4b/ldap-over-ssl-1.png 173w,\n/gatsbyjs/static/aa4da7e86955fac0bd7dfbc4f6f778ad/fc834/ldap-over-ssl-1.png 345w,\n/gatsbyjs/static/aa4da7e86955fac0bd7dfbc4f6f778ad/36727/ldap-over-ssl-1.png 690w,\n/gatsbyjs/static/aa4da7e86955fac0bd7dfbc4f6f778ad/73d01/ldap-over-ssl-1.png 786w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>En este apartado utilizaremos los certificados generados anteriormente en <a href=\"https://franmadu6.github.io/gatsbyjs/sa-open-stack-configuracion-https\">Quijote</a> para la realización de esta practica.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@freston:~$ tree claves/\nclaves/\n├── gonzalonazareno.crt\n├── openstack.crt\n└── openstack.key\n\n<span class=\"token number\">0</span> directories, <span class=\"token number\">3</span> files</code></pre></div>\n<p>Moveremos los archivos a los diferentes directorios pertinentes para la realización de este ejercicio.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debian@freston:~/claves$ <span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> gonzalonazareno.crt /etc/ssl/certs/\ndebian@freston:~/claves$ <span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> openstack.crt /etc/ssl/certs/\ndebian@freston:~/claves$ <span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> openstack.key /etc/ssl/private/</code></pre></div>\n<p>Vamos a otorgar los permisos necesarios sobre el fichero y directorio que lo contiene al usuario openldap, para ello necesitaremos instalar el paquete <strong>acl</strong> para una mejor y mas precisa asignación de permisos.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian/claves<span class=\"token comment\"># setfacl -m u:openldap:r-x /etc/ssl/private</span>\nroot@freston:/home/debian/claves<span class=\"token comment\"># setfacl -m u:openldap:r-x /etc/ssl/private/openstack.key</span></code></pre></div>\n<p>Antes de comenzar la configuración verificaremos el puerto que utiliza el servicio <strong>slapd</strong> que deberán ser el mismo que ldap (389/TCP).</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian/claves<span class=\"token comment\"># netstat -tlnp | egrep 'slapd'</span>\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:389             <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">506</span>/slapd           \ntcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::389                  :::*                    LISTEN      <span class=\"token number\">506</span>/slapd     </code></pre></div>\n<p>Dado que vamos a tratar los parámetros de configuración como si fuesen atributos de un objeto en el directorio, tendremos que crear un fichero de extensión <strong>.ldif</strong> que contenga las modificaciones a llevar a cabo:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian<span class=\"token comment\"># nano secure.ldif</span>\ndn: <span class=\"token assign-left variable\">cn</span><span class=\"token operator\">=</span>config\nchangetype: modify\nreplace: olcTLSCACertificateFile\nolcTLSCACertificateFile: /etc/ssl/certs/gonzalonazareno.crt           \n-\nreplace: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/ssl/private/openstack.key\n-\nreplace: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/ssl/certs/openstack.crt</code></pre></div>\n<p>Ahora lo importaremos, para modificar los atributos a la configuración, haciendo uso de <strong>ldapmodify</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian<span class=\"token comment\"># ldapmodify -Y EXTERNAL -H ldapi:/// -f secure.ldif </span>\nSASL/EXTERNAL authentication started\nSASL username: <span class=\"token assign-left variable\">gidNumber</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>+uidNumber<span class=\"token operator\">=</span><span class=\"token number\">0</span>,cn<span class=\"token operator\">=</span>peercred,cn<span class=\"token operator\">=</span>external,cn<span class=\"token operator\">=</span>auth\nSASL SSF: <span class=\"token number\">0</span>\nmodifying entry <span class=\"token string\">\"cn=config\"</span></code></pre></div>\n<p>Por defecto el protocolo no contempla la opción de ldaps así que deberemos implementarla:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian<span class=\"token comment\"># nano /etc/default/slapd </span>\n<span class=\"token assign-left variable\">SLAPD_SERVICES</span><span class=\"token operator\">=</span><span class=\"token string\">\"ldap:/// ldapi:/// ldaps:///\"</span></code></pre></div>\n<p>Reiniciaremos y veremos el estado del servicio <strong>slapd</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian<span class=\"token comment\"># systemctl restart slapd</span>\nroot@freston:/home/debian<span class=\"token comment\"># systemctl status slapd</span>\n● slapd.service - LSB: OpenLDAP standalone server <span class=\"token punctuation\">(</span>Lightweight Directory Access Protocol<span class=\"token punctuation\">)</span>\n   Loaded: loaded <span class=\"token punctuation\">(</span>/etc/init.d/slapd<span class=\"token punctuation\">;</span> generated<span class=\"token punctuation\">)</span>\n   Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Wed <span class=\"token number\">2021</span>-05-19 <span class=\"token number\">21</span>:06:42 CEST<span class=\"token punctuation\">;</span> 1min 52s ago\n     Docs: man:systemd-sysv-generator<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span>\n  Process: <span class=\"token number\">19189</span> <span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/etc/init.d/slapd start <span class=\"token punctuation\">(</span>code<span class=\"token operator\">=</span>exited, <span class=\"token assign-left variable\">status</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>/SUCCESS<span class=\"token punctuation\">)</span>\n    Tasks: <span class=\"token number\">3</span> <span class=\"token punctuation\">(</span>limit: <span class=\"token number\">562</span><span class=\"token punctuation\">)</span>\n   Memory: <span class=\"token number\">3</span>.7M\n   CGroup: /system.slice/slapd.service\n           └─19197 /usr/sbin/slapd -h ldap:/// ldapi:/// ldaps:/// -g openldap -u openldap -F /etc\n\nMay <span class=\"token number\">19</span> <span class=\"token number\">21</span>:06:42 freston systemd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>: Starting LSB: OpenLDAP standalone server <span class=\"token punctuation\">(</span>Lightweight Director\nMay <span class=\"token number\">19</span> <span class=\"token number\">21</span>:06:42 freston slapd<span class=\"token punctuation\">[</span><span class=\"token number\">19194</span><span class=\"token punctuation\">]</span>: @<span class=\"token punctuation\">(</span><span class=\"token comment\">#) $OpenLDAP: slapd  (Feb 14 2021 18:32:34) $</span>\n                                              Debian OpenLDAP Maintainers <span class=\"token operator\">&lt;</span>pkg-openldap-devel@list\nMay <span class=\"token number\">19</span> <span class=\"token number\">21</span>:06:42 freston slapd<span class=\"token punctuation\">[</span><span class=\"token number\">19197</span><span class=\"token punctuation\">]</span>: slapd starting\nMay <span class=\"token number\">19</span> <span class=\"token number\">21</span>:06:42 freston slapd<span class=\"token punctuation\">[</span><span class=\"token number\">19189</span><span class=\"token punctuation\">]</span>: Starting OpenLDAP: slapd.\nMay <span class=\"token number\">19</span> <span class=\"token number\">21</span>:06:42 freston systemd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>: Started LSB: OpenLDAP standalone server <span class=\"token punctuation\">(</span>Lightweight Directory</code></pre></div>\n<p>Comprobaremos que el nuevo protocolo escucha por el puerto <strong>636/TCP</strong> correctamente:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian<span class=\"token comment\"># netstat -tlnp | egrep 'slapd'</span>\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:389             <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">19197</span>/slapd         \ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:636             <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">19197</span>/slapd         \ntcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::389                  :::*                    LISTEN      <span class=\"token number\">19197</span>/slapd         \ntcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::636                  :::*                    LISTEN      <span class=\"token number\">19197</span>/slapd         </code></pre></div>\n<p>Pasando al lado del cliente en el que al igual que importamos certificados de autoridades certificadoras en el navegador para poder hacer uso del protocolo HTTPS, tendremos que hacerlo para aquellas aplicaciones manejadas desde línea de comandos, que hacen uso de otros protocolos cifrados, como por ejemplo <strong>ldaps://</strong>, el paquete encargado de la lista de autoridades certificadoras es <strong>ca-certificates</strong>, deberemos copiar el certificado de la autoridad certificadora IES Gonzalo Nazareno de /etc/ssl/certs/ a /usr/local/share/ca-certificates/ , crear el enlace simbólico y concatenarlo en el fichero <strong>ca-certificates.crt</strong> con los siguientes comandos:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian<span class=\"token comment\"># cp /etc/ssl/certs/gonzalonazareno.crt /usr/local/share/ca-certificates/</span>\nroot@freston:/home/debian<span class=\"token comment\"># update-ca-certificates </span>\nUpdating certificates <span class=\"token keyword\">in</span> /etc/ssl/certs<span class=\"token punctuation\">..</span>.\nrehash: warning: skipping duplicate certificate <span class=\"token keyword\">in</span> gonzalonazareno.pem\n<span class=\"token number\">1</span> added, <span class=\"token number\">0</span> removed<span class=\"token punctuation\">;</span> done.\nRunning hooks <span class=\"token keyword\">in</span> /etc/ca-certificates/update.d<span class=\"token punctuation\">..</span>.\ndone.</code></pre></div>\n<p>Para comprobarlo haremos una búsqueda anónima sobre el directorio haciendo uso de ldap sobre ssl/tls:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian<span class=\"token comment\"># ldapsearch -x -b \"dc=madu,dc=gonzalonazareno,dc=org\" -H ldaps://localhost:636</span>\n<span class=\"token comment\"># extended LDIF</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># LDAPv3</span>\n<span class=\"token comment\"># base &lt;dc=madu,dc=gonzalonazareno,dc=org> with scope subtree</span>\n<span class=\"token comment\"># filter: (objectclass=*)</span>\n<span class=\"token comment\"># requesting: ALL</span>\n<span class=\"token comment\">#</span>\n\n<span class=\"token comment\"># madu.gonzalonazareno.org</span>\ndn: <span class=\"token assign-left variable\">dc</span><span class=\"token operator\">=</span>madu,dc<span class=\"token operator\">=</span>gonzalonazareno,dc<span class=\"token operator\">=</span>org\nobjectClass: <span class=\"token function\">top</span>\nobjectClass: dcObject\nobjectClass: organization\no: madu.gonzalonazareno.org\ndc: madu\n\n<span class=\"token comment\"># admin, madu.gonzalonazareno.org</span>\ndn: <span class=\"token assign-left variable\">cn</span><span class=\"token operator\">=</span>admin,dc<span class=\"token operator\">=</span>madu,dc<span class=\"token operator\">=</span>gonzalonazareno,dc<span class=\"token operator\">=</span>org\nobjectClass: simpleSecurityObject\nobjectClass: organizationalRole\ncn: admin\ndescription: LDAP administrator\n\n<span class=\"token comment\"># Personas, madu.gonzalonazareno.org</span>\ndn: <span class=\"token assign-left variable\">ou</span><span class=\"token operator\">=</span>Personas,dc<span class=\"token operator\">=</span>madu,dc<span class=\"token operator\">=</span>gonzalonazareno,dc<span class=\"token operator\">=</span>org\nobjectClass: organizationalUnit\nou:: UGVyc29uYXMg\n\n<span class=\"token comment\"># Grupos, madu.gonzalonazareno.org</span>\ndn: <span class=\"token assign-left variable\">ou</span><span class=\"token operator\">=</span>Grupos,dc<span class=\"token operator\">=</span>madu,dc<span class=\"token operator\">=</span>gonzalonazareno,dc<span class=\"token operator\">=</span>org\nobjectClass: organizationalUnit\nou: Grupos\n\n<span class=\"token comment\"># search result</span>\nsearch: <span class=\"token number\">2</span>\nresult: <span class=\"token number\">0</span> Success\n\n<span class=\"token comment\"># numResponses: 5</span>\n<span class=\"token comment\"># numEntries: 4</span></code></pre></div>\n<p>Ahora deberemos de configurar correctamente ldap para haga uso del protocolo <strong>ldaps://</strong> por defecto, para ello deberemos añadir a la directiva <strong>URI</strong> la especificación <strong>ldaps://localhost</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian<span class=\"token comment\"># nano /etc/ldap/ldap.conf</span>\nURI     ldap://ldap.example.com ldap://ldap-master.example.com:666 ldaps://localhost</code></pre></div>\n<p>Repetiremos la consulta hecha anteriormente sin indicar el método de conexión:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@freston:/home/debian<span class=\"token comment\"># ldapsearch -x -b \"dc=madu,dc=gonzalonazareno,dc=org\"</span>\n<span class=\"token comment\"># extended LDIF</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># LDAPv3</span>\n<span class=\"token comment\"># base &lt;dc=madu,dc=gonzalonazareno,dc=org> with scope subtree</span>\n<span class=\"token comment\"># filter: (objectclass=*)</span>\n<span class=\"token comment\"># requesting: ALL</span>\n<span class=\"token comment\">#</span>\n\n<span class=\"token comment\"># madu.gonzalonazareno.org</span>\ndn: <span class=\"token assign-left variable\">dc</span><span class=\"token operator\">=</span>madu,dc<span class=\"token operator\">=</span>gonzalonazareno,dc<span class=\"token operator\">=</span>org\nobjectClass: <span class=\"token function\">top</span>\nobjectClass: dcObject\nobjectClass: organization\no: madu.gonzalonazareno.org\ndc: madu\n\n<span class=\"token comment\"># admin, madu.gonzalonazareno.org</span>\ndn: <span class=\"token assign-left variable\">cn</span><span class=\"token operator\">=</span>admin,dc<span class=\"token operator\">=</span>madu,dc<span class=\"token operator\">=</span>gonzalonazareno,dc<span class=\"token operator\">=</span>org\nobjectClass: simpleSecurityObject\nobjectClass: organizationalRole\ncn: admin\ndescription: LDAP administrator\n\n<span class=\"token comment\"># Personas, madu.gonzalonazareno.org</span>\ndn: <span class=\"token assign-left variable\">ou</span><span class=\"token operator\">=</span>Personas,dc<span class=\"token operator\">=</span>madu,dc<span class=\"token operator\">=</span>gonzalonazareno,dc<span class=\"token operator\">=</span>org\nobjectClass: organizationalUnit\nou:: UGVyc29uYXMg\n\n<span class=\"token comment\"># Grupos, madu.gonzalonazareno.org</span>\ndn: <span class=\"token assign-left variable\">ou</span><span class=\"token operator\">=</span>Grupos,dc<span class=\"token operator\">=</span>madu,dc<span class=\"token operator\">=</span>gonzalonazareno,dc<span class=\"token operator\">=</span>org\nobjectClass: organizationalUnit\nou: Grupos\n\n<span class=\"token comment\"># search result</span>\nsearch: <span class=\"token number\">2</span>\nresult: <span class=\"token number\">0</span> Success\n\n<span class=\"token comment\"># numResponses: 5</span>\n<span class=\"token comment\"># numEntries: 4</span></code></pre></div>\n<p>Como podemos comprobar ahora hacemos uso del protocolo ssl/tls de manera predeterminada a la hora de usar ldap.</p>","timeToRead":6,"excerpt":"Configura el servidor LDAP de frestón para que utilice el protocolo ldaps:// a la vez que el ldap:// utilizando el certificado x509 de la…","frontmatter":{"title":"LDAPs","cover":"https://img.icons8.com/ios/452/work.png","date":"2020-12-9","categories":["ASO"],"tags":["LDAP","Servidor","Frestón","x509"]},"fields":{"slug":"/lda-ps","date":"December 08, 2020"}}},"pageContext":{"slug":"/lda-ps","nexttitle":"Elección de Forma Jurídica","nextslug":"/eleccion-de-forma-juridica","prevtitle":"Instalación y configuración inicial de OpenLDAP","prevslug":"/instalacion-y-configuracion-inicial-de-open-ldap"}}}