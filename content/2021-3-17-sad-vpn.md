---
date: 2021-03-17
title: "[SAD] - Práctica: VPN con OpenVPN y certificados x509"
cover: "https://img.icons8.com/ios/452/work.png"
categories: 
    - SAD
tags:
    - VPN
    - OpenVPN
---

## Tarea 1: VPN de acceso remoto con OpenVPN y certificados x509Permalink

### Para esta tarea puedes usar el fichero heat del primer ejercicio. En esta tarea vas a realizar el segundo ejercicio del tema:

### Configura una conexión VPN de acceso remoto entre dos equipos:

* ### Uno de los dos equipos (el que actuará como servidor) estará conectado a dos redes

* ### Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.

* ### Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN. La dirección 10.99.99.1 se asignará al servidor VPN.

* ### Los ficheros de configuración del servidor y del cliente se crearán en el directorio /etc/openvpn de cada máquina, y se llamarán servidor.conf y cliente.conf respectivamente. La configuración establecida debe cumplir los siguientes aspectos:

    - **El demonio openvpn se manejará con systemctl.**
    - **Se debe configurar para que la comunicación esté comprimida.**
    - **La asignación de direcciones IP será dinámica.**
    - **Existirá un fichero de log en el equipo.**
    - **Se mandarán a los clientes las rutas necesarias.**

* ### Tras el establecimiento de la VPN, la máquina cliente debe ser capaz de acceder a una máquina que esté en la otra red a la que está conectado el servidor.

* ### Instala el complemento de VPN en networkmanager y configura el cliente de forma gráfica desde este complemento.

<hr>

* Escenario utilizado ➜ [Vagrantfile](documents/vagrantfilevpn.txt)

* Antes de comenzar deberemos tener ➜ [Autoridad Certificadora y Certificados.](https://franmadu6.github.io/gatsbyjs/configuracion-de-cliente-open-vpn-con-certificados-x-509)

## Cliente1
Instalamos el paquete **OpenVPN**.
```shell
vagrant@Cliente1:~$ sudo apt install openvpn
```

Crearemos un certificado para enviarselo a la unidad certificadora.
```shell
root@Cliente1:~/ca# openssl req -new -key /etc/ssl/private/maduvpn.key -out /root/maduvpn.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:Sevilla
Locality Name (eg, city) []:Dos Hermanas
Organization Name (eg, company) [Internet Widgits Pty Ltd]:IES Gonzalo Nazareno
Organizational Unit Name (eg, section) []:Informatica
Common Name (e.g. server FQDN or YOUR name) []:Francisco Javier Madueñpo Jurado
Email Address []:frandh1997@gmail.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
```

Una vez enviado esperaremos a que nos lo devuelva, una vez devuelto moveremos los certificados y la clave privada a /etc/openvpn/client
```shell
#desde el servidor
root@Servidor:~/ca# openssl x509 -req -in /home/vagrant/maduvpn.csr -CA certs/ca.cert.pem -CAkey private/ca.key.pem -CAcreateserial -out maduvpnfirmado.crt
Signature ok
subject=C = ES, ST = Sevilla, L = Dos Hermanas, O = IES Gonzalo Nazareno, OU = Informatica, CN = Francisco Javier Madue\C3\83\C2\B1po Jurado, emailAddress = frandh1997@gmail.com
Getting CA Private Key
Enter pass phrase for private/ca.key.pem:
```




## Servidor
Instalamos el paquete **OpenVPN**.
```shell
vagrant@Servidor:~$ sudo apt install openvpn
```

Utilizando dhparam crearemos la clave Diffie-Hellman.
```shell
vagrant@Servidor:~$ cd /etc/openvpn/
vagrant@Servidor:/etc/openvpn$ sudo openssl dhparam -out dhparams.pem 4096
Generating DH parameters, 4096 bit long safe prime, generator 2
This is going to take a long time
......................................................................
```

Activamos el bit de forward para permitr el tráfico.
```shell
root@Servidor:/etc/openvpn# echo 1 > /proc/sys/net/ipv4/ip_forward
```

Crearemos un fichero de configuración para **OpenVPN**.
```shell
root@Servidor:/etc/openvpn# nano /etc/openvpn/servidor.conf
dev tun
server 10.99.99.0 255.255.255.0 
push "route 10.10.10.0 255.255.255.0"
tls-server
dh /etc/openvpn/dhparams.pem
ca /root/ca/certs/ca.cert.pem
cert /etc/openvpn/serverVPN.crt 
key /etc/ssl/private/servidorvpn.key
comp-lzo
keepalive 10 60
verb 3
askpass /etc/openvpn/pass.txt
```

Generaremos un fichero para guardar contraseñas y se reconocido por el parámetro **askpass**.
```shell
root@Servidor:/etc/openvpn# touch pass.txt
root@Servidor:/etc/openvpn# echo "fran" > pass.txt
```

Descomentaremos las siguiente linea para que openvpn reconozca systemd(ficheros de configuración).
```shell
root@Servidor:/etc/openvpn# nano /etc/default/openvpn
AUTOSTART="all"
```

Reiniciamos servicio y comprobamos su estado.
```shell
root@Servidor:/etc/openvpn# systemctl restart openvpn.service
root@Servidor:/etc/openvpn# systemctl status openvpn.service
● openvpn.service - OpenVPN service
   Loaded: loaded (/lib/systemd/system/openvpn.service; enabled; vendor preset: enabled)
   Active: active (exited) since Mon 2021-03-22 11:56:28 UTC; 8s ago
  Process: 1549 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
 Main PID: 1549 (code=exited, status=0/SUCCESS)

Mar 22 11:56:28 Servidor systemd[1]: Starting OpenVPN service...
Mar 22 11:56:28 Servidor systemd[1]: Started OpenVPN service.
```


## Cliente 2

Eliminaremos la tabla de enrutamiento por defecto y le añadiremos la direccion priuvada de nuestro servidor.
```shell
vagrant@Cliente2:~$ sudo ip r del default
vagrant@Cliente2:~$ sudo ip r add default via 192.168.100.10
```

## Cliente 1

Ahora con los dos certificados, crearemos el fichero de configuración del cliente.
```shell
root@Cliente1:/etc/openvpn# nano vpn.conf
dev tun
remote 172.22.3.32
ifconfig 10.99.99.0 255.255.255.0
pull
tls-client
ca /etc/openvpn/client/ca.cert.pem
cert /etc/openvpn/client/maduvpnfirmado.crt
key /etc/openvpn/client/maduvpn.key
comp-lzo
keepalive 10 60
verb 3
askpass /etc/openvpn/client/pass.txt
```

Volveremos a generar un fichero para **askpass**.
```shell
root@Cliente1:/etc/openvpn# touch pass.txt
root@Cliente1:/etc/openvpn# echo "fran" > pass.txt
```

Volvewremos a descomentar las lineas del fichero etc/default/openvpn esta vez del cliente.
```shell
root@Cliente1:/etc/openvpn# nano /etc/default/openvpn
AUTOSTART="all"
```

Reiniciaremos el servicio.
```shell
root@Cliente1:/etc/openvpn# systemctl restart openvpn.service
```

Realizaremos un ip a para comprobar que la interfaz tun ha sido generada.
```shell

```



ca /etc/openvpn/keys/ca.crt #Certificado de la CA


cert /etc/openvpn/keys/server.crt #Certificado local (servidor)


key /etc/openvpn/keys/server.key #Clave privada local (servidor)