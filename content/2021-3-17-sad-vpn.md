---
date: 2021-03-17
title: "[SAD] - Práctica: VPN con OpenVPN y certificados x509"
cover: "https://img.icons8.com/ios/452/work.png"
categories: 
    - SAD
tags:
    - VPN
    - OpenVPN
---

## Tarea 1: VPN de acceso remoto con OpenVPN y certificados x509Permalink

### Para esta tarea puedes usar el fichero heat del primer ejercicio. En esta tarea vas a realizar el segundo ejercicio del tema:

### Configura una conexión VPN de acceso remoto entre dos equipos:

* ### Uno de los dos equipos (el que actuará como servidor) estará conectado a dos redes

* ### Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.

* ### Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN. La dirección 10.99.99.1 se asignará al servidor VPN.

* ### Los ficheros de configuración del servidor y del cliente se crearán en el directorio /etc/openvpn de cada máquina, y se llamarán servidor.conf y cliente.conf respectivamente. La configuración establecida debe cumplir los siguientes aspectos:

    - **El demonio openvpn se manejará con systemctl.**
    - **Se debe configurar para que la comunicación esté comprimida.**
    - **La asignación de direcciones IP será dinámica.**
    - **Existirá un fichero de log en el equipo.**
    - **Se mandarán a los clientes las rutas necesarias.**

* ### Tras el establecimiento de la VPN, la máquina cliente debe ser capaz de acceder a una máquina que esté en la otra red a la que está conectado el servidor.

* ### Instala el complemento de VPN en networkmanager y configura el cliente de forma gráfica desde este complemento.

<hr>

* Escenario utilizado ➜ [Vagrantfile](documents/vagrantfilevpn.txt)

* Antes de comenzar deberemos tener ➜ [Autoridad Certificadora y Certificados.](2020-11-03-openvpn-cert.md)

## Cliente1
Instalamos el paquete **OpenVPN**.
```shell
vagrant@Cliente1:~$ sudo apt install openvpn
```

## Servidor
Instalamos el paquete **OpenVPN**.
```shell
vagrant@Servidor:~$ sudo apt install openvpn
```

Utilizando dhparam crearemos la clave Diffie-Hellman.
```shell
vagrant@Servidor:~$ cd /etc/openvpn/
vagrant@Servidor:/etc/openvpn$ sudo openssl dhparam -out dhparams.pem 4096
Generating DH parameters, 4096 bit long safe prime, generator 2
This is going to take a long time
......................................................................
```

Activamos el bit de forward para permitr el tráfico.
```shell
root@Servidor:/etc/openvpn# echo 1 > /proc/sys/net/ipv4/ip_forward
```

Crearemos un fichero de configuración para **OpenVPN**.
```shell
dev tun
server 10.99.99.0 255.255.255.0 
push "route 192.168.100.0 255.255.255.0"
tls-server
dh /etc/openvpn/dhparams.pem
ca /etc/openvpn/ca.cert.pem
cert /etc/openvpn/serverVPN.crt 
key /etc/openvpn/serverVPN.key
comp-lzo
keepalive 10 60
verb 3
askpass pass.txt
```


