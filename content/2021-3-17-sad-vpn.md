---
date: 2021-03-17
title: "[SAD] - Práctica: VPN con OpenVPN y certificados x509"
cover: "https://img.icons8.com/ios/452/work.png"
categories: 
    - SAD
tags:
    - VPN
    - OpenVPN
---

## Tarea 1: VPN de acceso remoto con OpenVPN y certificados x509Permalink

### Para esta tarea puedes usar el fichero heat del primer ejercicio. En esta tarea vas a realizar el segundo ejercicio del tema:

### Configura una conexión VPN de acceso remoto entre dos equipos:

* ### Uno de los dos equipos (el que actuará como servidor) estará conectado a dos redes

* ### Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.

* ### Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN. La dirección 10.99.99.1 se asignará al servidor VPN.

* ### Los ficheros de configuración del servidor y del cliente se crearán en el directorio /etc/openvpn de cada máquina, y se llamarán servidor.conf y cliente.conf respectivamente. La configuración establecida debe cumplir los siguientes aspectos:

    - **El demonio openvpn se manejará con systemctl.**
    - **Se debe configurar para que la comunicación esté comprimida.**
    - **La asignación de direcciones IP será dinámica.**
    - **Existirá un fichero de log en el equipo.**
    - **Se mandarán a los clientes las rutas necesarias.**

* ### Tras el establecimiento de la VPN, la máquina cliente debe ser capaz de acceder a una máquina que esté en la otra red a la que está conectado el servidor.

* ### Instala el complemento de VPN en networkmanager y configura el cliente de forma gráfica desde este complemento.

<hr>

* Escenario utilizado ➜ [Vagrantfile](documents/vagrantfilevpn.txt)


Prepararemos el entorno instalando openvpn/easy-rsa, en nuestras maquinas previamentes ya tendremos instalado openvpn y git(si has usado el Vagrantfile de esta practica ya los tendras incorporados).
```shell
root@servidor:/home/vagrant# git clone https://github.com/OpenVPN/easy-rsa
```

Copiaremos el directorio /easyrsa3/vars.example en /easyrsa3/vars y modificaremos lo siguiente:
```shell
root@servidor:/home/vagrant# cp easy-rsa/easyrsa3/vars.example easy-rsa/easyrsa3/vars
root@servidor:/home/vagrant# nano easy-rsa/easyrsa3/vars
set_var EASYRSA_REQ_COUNTRY     "ES"
set_var EASYRSA_REQ_PROVINCE    "Sevilla"
set_var EASYRSA_REQ_CITY        "Dos Hermanas" 
set_var EASYRSA_REQ_ORG         "iesgn.org"
set_var EASYRSA_REQ_EMAIL       "frandh1997@gmail.com"
set_var EASYRSA_REQ_OU          "iesgn.org"
```

Utilizaremos el script de easyrsa para generar el directorio /pki/ que será donde se almacenarán las claves y certificados.
```shell
root@servidor:/home/vagrant/easy-rsa/easyrsa3# chmod 700 ./easyrsa
root@servidor:/home/vagrant/easy-rsa/easyrsa3# ./easyrsa init-pki

Note: using Easy-RSA configuration from: /home/vagrant/easy-rsa/easyrsa3/vars

init-pki complete; you may now create a CA or requests.
Your newly created PKI dir is: /home/vagrant/easy-rsa/easyrsa3/pki
```

Comenzaremos creando las **Credenciales CA** utilizando el parámetro build-ca.
```shell
root@servidor:/home/vagrant/easy-rsa/easyrsa3# ./easyrsa build-ca

Note: using Easy-RSA configuration from: /home/vagrant/easy-rsa/easyrsa3/vars
Using SSL: openssl OpenSSL 1.1.1d  10 Sep 2019

Enter New CA Key Passphrase: #fran
Re-Enter New CA Key Passphrase: #fran
Generating RSA private key, 2048 bit long modulus (2 primes)
.........+++++
...........+++++
e is 65537 (0x010001)
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Common Name (eg: your user, host, or server name) [Easy-RSA CA]:iesgn.org

CA creation complete and you may now import and sign cert requests.
Your new CA certificate file for publishing is at:
/home/vagrant/easy-rsa/easyrsa3/pki/ca.crt
```

**Credenciales Servidor**, utilizaremos el script build-server-full mas el nombre del fichero, nos pediran la frase de paso que pusimos anteriormente.
```shell
root@servidor:/home/vagrant/easy-rsa/easyrsa3# ./easyrsa build-server-full servidor

Note: using Easy-RSA configuration from: /home/vagrant/easy-rsa/easyrsa3/vars
Using SSL: openssl OpenSSL 1.1.1d  10 Sep 2019
Generating a RSA private key
...............+++++
.......................................................................+++++
writing new private key to '/home/vagrant/easy-rsa/easyrsa3/pki/easy-rsa-3582.ojRSnD/tmp.Uh9gOQ'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
Using configuration from /home/vagrant/easy-rsa/easyrsa3/pki/easy-rsa-3582.ojRSnD/tmp.6ZCHcr
Enter pass phrase for /home/vagrant/easy-rsa/easyrsa3/pki/private/ca.key:
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
commonName            :ASN.1 12:'servidor'
Certificate is to be certified until Jun 27 13:28:19 2023 GMT (825 days)

Write out database with 1 new entries
Data Base Updated
```

**Credenciales Cliente**, Llamaré al cliente Lorita y utilizaremos un script muy parecido al anterior.
```shell
root@servidor:/home/vagrant/easy-rsa/easyrsa3# ./easyrsa build-client-full Lorita

Note: using Easy-RSA configuration from: /home/vagrant/easy-rsa/easyrsa3/vars
Using SSL: openssl OpenSSL 1.1.1d  10 Sep 2019
Generating a RSA private key
..................+++++
.......+++++
writing new private key to '/home/vagrant/easy-rsa/easyrsa3/pki/easy-rsa-3660.Hs0oQN/tmp.JCziTw'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
Using configuration from /home/vagrant/easy-rsa/easyrsa3/pki/easy-rsa-3660.Hs0oQN/tmp.obBDlb
Enter pass phrase for /home/vagrant/easy-rsa/easyrsa3/pki/private/ca.key:
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
commonName            :ASN.1 12:'Lorita'
Certificate is to be certified until Jun 27 13:32:35 2023 GMT (825 days)

Write out database with 1 new entries
Data Base Updated
```

**Clave Diffie Hellman**, es un protocolo de establecimiento de claves entre partes que no han tenido contacto previo, utilizando un canal inseguro y de manera anónima (no autenticada). Puede demorarse un poco su generación.
```shell
root@servidor:/home/vagrant/easy-rsa/easyrsa3# ./easyrsa gen-dh

Note: using Easy-RSA configuration from: /home/vagrant/easy-rsa/easyrsa3/vars
Using SSL: openssl OpenSSL 1.1.1d  10 Sep 2019
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
.......+....................................................................................................................................................................................................+...................................................................................................................................................................................................................+.......................................................+....+......................................+....................................................................................................................................................................................................................................................................................................................................................+.....................................+......................................................................................+................+............................................................+.............................+.....................+..........................................................................................................+..........................................+..............................................................................................................................................................................................................................................................................................+.................................................................................................+.....................................+.............................................................................+..+..........................+..........................................................+........................................+.............................................................................................................................................................++*++*++*++*

DH parameters of size 2048 created at /home/vagrant/easy-rsa/easyrsa3/pki/dh.pem
```

Después de obtener todas las credenciales necesarias configuraremos el fichero de **OpenVPN**, antes de ello organizaremos un poco nuestros archivos, crearemos y moveremos los archivos a una carpeta pki en openvpn.
```shell
root@servidor:/etc/openvpn/pki# tree
.
├── ca
│   ├── ca.crt
│   └── ca.key
├── dh.pem
└── server
    ├── servidor.crt
    └── servidor.key

2 directories, 5 files
```

Ahora es paso al fichero de configuración del servidor:
```shell
root@servidor:/etc/openvpn# nano remotovpn.conf
#Dispositivo de túnel
dev tun

#Protocolo de red
proto tcp

#Direcciones IP virtuales
server 10.99.99.0 255.255.255.0

#subred local
push "route 192.168.100.0 255.255.255.0"

#Rol de servidor
tls-server

#Parámetros Diffie-Hellman
dh /etc/openvpn/pki/dh.pem

#Certificado de la CA
ca /etc/openvpn/pki/ca/ca.crt

#Certificado local
cert /etc/openvpn/pki/server/servidor.crt

#Clave privada local
key /etc/openvpn/pki/server/servidor.key

#Activar la compresión LZO
comp-lzo

#Detectar caídas de la conexión
keepalive 10 60

#Nivel de información
verb 3

# Contraseña del certificado del servidor
askpass passwd.txt
```

Crearemos un archivo para almacenas las contraseñas de **askpass**.
```shell
root@servidor:/etc/openvpn# nano passwd.txt
fran
```

Ahora toca probar el resultado reiniciaremos el servicio de openvpn y comprobaremos que este escuchando por el puerto 1194.
```shell
root@servidor:/etc/openvpn# service openvpn restart
root@servidor:/home/vagrant# lsof -i -P -n | grep openvpn
openvpn   659     root    6u  IPv4  14154      0t0  TCP *:1194 (LISTEN)

root@servidor:/etc/openvpn# service openvpn status
● openvpn.service - OpenVPN service
   Loaded: loaded (/lib/systemd/system/openvpn.service; enabled; vendor preset: enabled)
   Active: active (exited) since Wed 2021-03-24 14:02:35 UTC; 18s ago
  Process: 3892 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
 Main PID: 3892 (code=exited, status=0/SUCCESS)

Mar 24 14:02:35 servidor systemd[1]: Starting OpenVPN service...
Mar 24 14:02:35 servidor systemd[1]: Started OpenVPN service.
#nueva interfaz generada
5: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100
    link/none 
    inet 10.99.99.1 peer 10.99.99.2/32 scope global tun0
       valid_lft forever preferred_lft forever
```






## Tarea 2: VPN sitio a sitio con OpenVPN y certificados x509Permalink

## Esta tarea la puedes hacer con un compañero.

## Configura una conexión VPN sitio a sitio entre dos equipos del cloud:

## Cada equipo estará conectado a dos redes, una de ellas en común
## Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.
## Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN.
## Tras el establecimiento de la VPN, una máquina de cada red detrás de cada servidor VPN debe ser capaz de acceder a una máquina del otro extremo.
